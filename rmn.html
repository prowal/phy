<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 
	MIT License

	La Belle Physique : RMN

	Copyright (c) 2018 Gaétan Walter

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->

	<title>Générateur RMN</title>

	<link rel="icon" href="img/rmn.ico" />

	<link rel="stylesheet" href="lib/w3.css"> 
	<link rel="stylesheet" href="lib/w3-theme-teal.css"> 
	<link rel="stylesheet" href="lib/w3-theme-indigo.css"> 

	<link rel="stylesheet" href="lib/fontawesome/css/all.min.css">

	<link rel="stylesheet" href="lib/phy.css">

	<script src="lib/Chart.min.js"></script>

	<script src="lib/rmn.js"></script>

	<script src="lib/phy.js"></script>
	<script src="lib/infomodal.js"></script>

	<style>
		/* Give inputs width*/
		input[type=number]{
			width: 60px;
		}
		.range-slider_range{
    transform: rotateY(180deg);
		}
	</style>

</head>
<body class="w3-light-grey">
	<!-- Header bar -->
	<div class="header w3-theme">
		<div class="w3-bar w3-card-4 w3-center">
			<span class="w3-bar-item w3-display-topmiddle w3-xlarge"><b>Générateur simpliste de spectres RMN</b></span>
			<button class="w3-bar-item w3-button w3-right w3-xlarge" id="infoButton"><b><i class="fas fa-info-circle fa-lg"></i></b></button>
			<a href="index.html" class="w3-bar-item w3-button w3-left w3-xlarge" id="homeButton"><b><i class="fas fa-home fa-lg"></i></b></a>
		</div> 
	</div>

	<div class="w3-row">
		<div class="w3-col w3-right" style="width: 320px">
			<!-- First right card -->
			<div class="w3-card-4 w3-margin w3-white">
				<header class="w3-container w3-theme">
					<h3>Ajouter des pics</h3>
				</header>
				<table class="w3-table w3-bordered w3-centered">
					<tr>
						<th class="w3-opacity">PPM</th>
						<th class="w3-opacity">Mul</th>
						<th class="w3-opacity">Nb H</th>
						<th> </th>
					</tr>
					<tr id="peak1" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput1" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput1" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput1" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton1"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak2" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput2" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput2" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput2" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton2"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak3" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput3" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput3" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput3" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton3"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak4" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput4" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput4" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput4" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton4"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak5" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput5" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput5" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput5" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton5"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak6" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput6" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput6" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput6" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton6"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak7" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput7" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput7" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput7" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton7"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak8" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput8" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput8" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput8" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton8"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
					<tr id="peak9" style="display : none">
						<td><input type="number" class="w3-input no-spin" id="ppmInput9" step="0.01"></td>
						<td><input type="number" class="w3-input" id="mulInput9" min="1" max="7" value="1"></td>
						<td><input type="number" class="w3-input" id="nbHInput9" min="1" max="20" value="1"></td>
						<td style="padding: 0px"><button class="w3-bar-item w3-button w3-right w3-large w3-hover-red" id="removePeakButton9"><i class="fas fas fa-minus-circle"></i></button></td>
					</tr>
				</table>
				<button class="w3-button w3-block w3-hover-green" id="addPeakButton"><i class="fas fa-plus-circle fa-lg"></i></button>
			</div>
			<!-- Second right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Courbe d'intégration</h3>
				</header>
				<div class="w3-container w3-white">
					<div class="w3-bar w3-padding">
						<span class="w3-bar-item">Visible : </span>
						<label class="switch w3-right">
							<input type="checkbox" id="integrationCheckbox">
							<span class="toggleSlider round"></span>
						</label>
					</div> 
				</div>
			</div>
			<!-- Third right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Paramètres</h3>
				</header>
				<table class="w3-table w3-centered w3-white">
					<tr>
						<td>Largeur des pics :</td>
						<td><input class="range-slider_range" style="width:80px" id="peakSizeSlider" type="range" value="200" min="100" max="300" step="100"></td>
					</tr>
					<tr>
						<td>Monochrome :</td>
						<td>
							<label class="switch">
								<input type="checkbox" id="bwCheckbox">
								<span class="toggleSlider round"></span>
							</label>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<!-- Canvas card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div class="w3-container w3-margin" style="height: calc(100vh - 120px)">
				<canvas class="canvas"></canvas>
			</div>
		</div>
	</div>

	<!-- Modal card -->
	<script>modalWrite("rmn");</script>

<script>
const $ = document.querySelector.bind(document);

// Get canvas context
const canvasCtx = $("canvas.canvas").getContext("2d");

// Get buttons contexts
const infoButton = $("#infoButton");
infoButton.addEventListener("click", onInfoButtonClick);
const closeInfoButton = $("#closeInfoButton");
closeInfoButton.addEventListener("click", onCloseInfoButtonClick);

const removePeakButton = []
removePeakButton[0] = $("#removePeakButton1");
removePeakButton[1] = $("#removePeakButton2");
removePeakButton[2] = $("#removePeakButton3");
removePeakButton[3] = $("#removePeakButton4");
removePeakButton[4] = $("#removePeakButton5");
removePeakButton[5] = $("#removePeakButton6");
removePeakButton[6] = $("#removePeakButton7");
removePeakButton[7] = $("#removePeakButton8");
removePeakButton[8] = $("#removePeakButton9");

for(let i = 0; i < 9; i++){
	removePeakButton[i].addEventListener("click", function(){onRemovePeakButton(i);});
}

const addPeakButton = $("#addPeakButton");
addPeakButton.addEventListener("click", onAddPeakButton);

// Get inputs contexts
const ppmInput = []
ppmInput[0] = $("#ppmInput1");
ppmInput[1] = $("#ppmInput2");
ppmInput[2] = $("#ppmInput3");
ppmInput[3] = $("#ppmInput4");
ppmInput[4] = $("#ppmInput5");
ppmInput[5] = $("#ppmInput6");
ppmInput[6] = $("#ppmInput7");
ppmInput[7] = $("#ppmInput8");
ppmInput[8] = $("#ppmInput9");

for(let i = 0; i < 9; i++){
	ppmInput[i].addEventListener("input", function(){onPpmInput(i);});
}

const mulInput = []
mulInput[0] = $("#mulInput1");
mulInput[1] = $("#mulInput2");
mulInput[2] = $("#mulInput3");
mulInput[3] = $("#mulInput4");
mulInput[4] = $("#mulInput5");
mulInput[5] = $("#mulInput6");
mulInput[6] = $("#mulInput7");
mulInput[7] = $("#mulInput8");
mulInput[8] = $("#mulInput9");

for(let i = 0; i < 9; i++){
	mulInput[i].addEventListener("input", function(){onMulInput(i);});
}

const nbHInput = []
nbHInput[0] = $("#nbHInput1");
nbHInput[1] = $("#nbHInput2");
nbHInput[2] = $("#nbHInput3");
nbHInput[3] = $("#nbHInput4");
nbHInput[4] = $("#nbHInput5");
nbHInput[5] = $("#nbHInput6");
nbHInput[6] = $("#nbHInput7");
nbHInput[7] = $("#nbHInput8");
nbHInput[8] = $("#nbHInput9");

for(let i = 0; i < 9; i++){
	nbHInput[i].addEventListener("input", function(){onnbHInput(i);});
}

// Get checkboxs contexts
const integrationCheckbox = $("#integrationCheckbox");
integrationCheckbox.addEventListener("click", onIntegrationCheckbox);

const bwCheckbox = $("#bwCheckbox");
bwCheckbox.addEventListener("click", onBwCheckbox);

// Get sliders contexts
const peakSizeSlider = $("#peakSizeSlider");
peakSizeSlider.addEventListener("input", onPeakSizeSlider);

// Declare vars
const totalPPM = 14;
const maxMultiplicity = 7;
const maxNbH = 20;

const maxPeakCount = 9;

let data1 = [];
let data2 = [];
//let peaks = [];

let chart;

let nmr = new NMR(totalPPM, peakSizeSlider.value);

/*----------------------------------------------------------------------------------------------
-----------------------------------------GRAPH SETTINGS-----------------------------------------
----------------------------------------------------------------------------------------------*/
let config = {
	type: "line",
	data: {
		datasets: [{
			label: "Courbe d'integration",
			borderColor: phyColors.deepOrange,
			// Hides the points...
			radius: 0,
			hitRadius: 0,
			borderWidth: 2,
			fill: false,
			hidden: true
		},{
			label: "Spectre RMN",
			borderColor: phyColors.theme2,
			radius: 0,
			hitRadius: 0,
			fill: false
		}
		]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false
		},
		/*tooltips: {
      enabled: false
    },*/
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Déplacement chimique (ppm)"
				},
				ticks: {
					min: 0,
					max: totalPPM,
					reverse: true,
					//autoSkip: true,
					//maxTicksLimit: 10,
					stepSize: 1
				}
			}],
			yAxes: [{
				display: false,
				scaleLabel: {
					display: false,
					padding: 0,
				},
				ticks: {
					display: false,
					suggestedMin: -1,
					suggestedMax: 6,
				}
			}]
		}
	}
};

/*----------------------------------------------------------------------------------------------
------------------------------------------DRAW FUNCTION-----------------------------------------
----------------------------------------------------------------------------------------------*/
function draw() {
	// Generate the RMN spectrum
	data1 = nmr.generateNMR();
	data2 = nmr.generateIntegration()

	//Update the graph
	chart.data.datasets[0].data = data2;
	chart.data.datasets[1].data = data1;
	chart.update();
}

/*----------------------------------------------------------------------------------------------
------------------------------------POPULATE PEAK CONTROLS--------------------------------------
----------------------------------------------------------------------------------------------*/
function populatePeakControls(){
	// Hide all controls
	for(let i = 1; i < maxPeakCount + 1; i++){ // TODOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO
		$("#peak"+i).style.display = "none";
	};
	// Show and set active controls
	for(let i = 1; i < nmr.peaks.length + 1; i++){
		$("#peak"+i).style.display = "table-row";
		ppmInput[i-1].value = nmr.peaks[i-1].ppm;
		mulInput[i-1].value = nmr.peaks[i-1].mul;
		nbHInput[i-1].value = nmr.peaks[i-1].nbH;
	};

	// Show or hide + button
	if(nmr.peaks.length == maxPeakCount){
		addPeakButton.style.display = "none";
	}
	else{
		addPeakButton.style.display = "block";
	};

	// Show or hide - buttons
	if(nmr.peaks.length == 1){
		removePeakButton1.style.display = "none";
	}
	else{
		removePeakButton1.style.display = "table-row";
	};
}

/*----------------------------------------------------------------------------------------------
---------------------------------------------EVENTS---------------------------------------------
----------------------------------------------------------------------------------------------*/
window.onload = function() {
	// Add an initial peak
	nmr.peaks[0] = {ppm: 1, mul: 3, nbH: 1};
	populatePeakControls();

	// Set the pointPerPPM
	nmr.pointPerPPM = peakSizeSlider.value;

	// Create the graph and link the datas
	chart = new Chart(canvasCtx, config);
	draw();
};

function onInfoButtonClick() {
	$("#infoModal").style.display = "block";
};
function onCloseInfoButtonClick(){
	$("#infoModal").style.display="none";
}

function onPpmInput(_peak) {
	// Max ppm input value
	if(ppmInput[_peak].value > totalPPM){
		ppmInput[_peak].value = totalPPM;
	}
	// Min ppm input value
	if(ppmInput[_peak].value < 0){
		ppmInput[_peak].value = 0;
	}
	nmr.peaks[_peak].ppm = parseFloat(ppmInput[_peak].value);
	draw();
};

function onMulInput(_peak) {
	// Int only
	if(mulInput[_peak].value % 1 != 0){
		mulInput[_peak].value = Math.round(mulInput[_peak].value);
	}
	// Max ppm input value
	if(mulInput[_peak].value > maxMultiplicity){
		mulInput[_peak].value = maxMultiplicity;
	}
	nmr.peaks[_peak].mul = parseInt(mulInput[_peak].value);
	draw();
};

function onnbHInput(_peak) {
	if(nbHInput[_peak].value % 1 != 0){
		nbHInput[_peak].value = Math.round(nbHInput[_peak].value);
	}
	// Max ppm input value
	if(nbHInput[_peak].value > maxNbH){
		nbHInput[_peak].value = maxNbH;
	}
	nmr.peaks[_peak].nbH = parseInt(nbHInput[_peak].value);
	draw();
};

function onRemovePeakButton(_peak) {
	nmr.peaks.splice(_peak,1);
	populatePeakControls();
	draw();
};

function onAddPeakButton() {
	let newPeak;
	let ok;
for(let i = 10; i < totalPPM * 10; i++){
	ok = true;
	for(j = 0; j < nmr.peaks.length; j++){
		if(i * 0.1 > nmr.peaks[j].ppm - 1 && i * 0.1 < nmr.peaks[j].ppm + 1){
			ok = false;
		}
	}
	if(ok == true){
		newPeak = {ppm: i * 0.1, mul: 1, nbH: 1};
		break;
	}
}

	nmr.peaks.push(newPeak);
	populatePeakControls();
	draw();
};

function onIntegrationCheckbox() {
	if(integrationCheckbox.checked) {
		chart.data.datasets[0].hidden = false;
	}
	else{
		chart.data.datasets[0].hidden = true;
	}
	draw();
};

function onPeakSizeSlider() {
	nmr.pointPerPPM = peakSizeSlider.value;
	draw();
};

function onBwCheckbox() {
	if(bwCheckbox.checked) {
		chart.data.datasets[0].borderColor = phyColors.black;
		chart.data.datasets[1].borderColor = phyColors.black;
	}
	else{
		chart.data.datasets[0].borderColor = phyColors.deepOrange;
		chart.data.datasets[1].borderColor = phyColors.theme2;
	}
	draw();
};

</script>
</body>
</html> 