<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 
	MIT License

	La Belle Physique : Analyseur audio

	Copyright (c) 2018 Gaétan Walter

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->

	<title>Analyseur audio</title>

	<link rel="stylesheet" href="lib/w3.css">
	<link rel="stylesheet" href="lib/w3-theme-teal.css"> 
	<link rel="stylesheet" href="lib/w3-theme-indigo.css"> 

	<link rel="stylesheet" href="lib/fontawesome/css/all.min.css">

	<link rel="stylesheet" href="lib/phy.css">

	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

	<script src="lib/Chart.min.js"></script>

	<script src="lib/phy.js"></script>

	<script src="lib/audio.js"></script>

	<script src="lib/fourier.js"></script>

	<style>

	</style>

</head>
<body class="w3-light-grey">
	<!-- Header bar -->
	<div class="w3-card-4 w3-theme">
		<div class="w3-bar w3-center">
			<span class="w3-bar-item w3-display-topmiddle w3-xlarge"><b>Analyseur audio</b></span>
			<button class="w3-bar-item w3-button w3-right w3-xlarge" id="infoButton"><b><i class="fas fa-info-circle fa-lg"></i></b></button>
			<a href="index.html" class="w3-bar-item w3-button w3-left w3-xlarge" id="homeButton"><b><i class="fas fa-home fa-lg"></i></b></a>
		</div>
		<div id="tabBar" class="w3-bar">
			<button id ="rtTabButton" class="w3-bar-item w3-button w3-hover-none phy-tab">TEMPS REEL</button>
			<button id ="recTabButton" class="w3-bar-item w3-button w3-hover-none phy-tab">ENREGISTRER</button>
			<span class="w3-bar-item w3-opacity"><i class="fas fa-minus fa-rotate-90"></i></span>
			<!--<span class="w3-bar-item" style="padding:0px;"><span class="w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Test</span><span class="w3-button w3-hover-none phy-tab-close-button"><i class="fas fa-times"></i></span></span>
			<span class="w3-bar-item" style="padding:0px;"><span class="w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Test</span><span class="w3-button w3-hover-none phy-tab-close-button"><i class="fas fa-times"></i></span></span>
			-->
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!-------------------------------REALTIME TAB------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="rtTab" class="w3-row">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Paramètres</h3>
				</header>
				<div class="w3-container w3-white">
					<label class="w3-opacity phy-menu-label"><b>Amplification :</b></label>
					<input class="range-slider_range" id="rtAmplificationSlider" type="range" value="10" min="0" max="20">
					<span class="range-slider_value" id="rtAmplificationValue">x 1</span>
					<label class="w3-opacity phy-menu-label"><b>Fréquence d'échantillonage</b></label>
					<select id="rtSampleRateSelect" class="w3-select" name="option">
					</select> 
				</div>
			</div>
			<!-- Second element -->
			<div class="w3-card-4 phy-menu-element w3-white" >
				<button class="w3-button w3-block w3-hover-red" id="pauseButton"><h3 style="margin:0"><i class="fas fa-pause"></i> Pause</h3></button>
				<button class="w3-button w3-block" id="rtSaveButton" style="display:none"><h3 style="margin:0"><i class="fas fa-save"></i> Sauvegarder</h3></button>
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div style="height: 41vh;">
					<canvas class="rtWaveCanvas"></canvas>
				</div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div style="height: 36vh;">
					<canvas class="rtFourierCanvas"></canvas>
				</div>
			</div>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!--------------------------------RECORD TAB-------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="recTab" class="w3-row" style="display:none">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Acquisition</h3>
				</header>
				<div class="w3-container w3-white">
					<label class="w3-opacity phy-menu-label"><b>Durée d'acquisition</b></label>
					<input type="number" class="w3-input" id="sampleLengthInput" value="0.05" step="0.01" min="0.01" max="20">
					<label class="w3-opacity phy-menu-label"><b>Fréquence d'échantillonage</b></label>
					<select id="recSampleRateSelect" class="w3-select" name="option">
					</select> 
					<button class="w3-button w3-block w3-theme w3-hover-theme2" id="sampleButton" style="margin-top: 25px; margin-bottom: 15px;"><h3 style="margin:0"><i class="fas fa-microphone"></i> Acquisition</h3></button>
					<button class="w3-button w3-block" id="recSaveButton" style="margin-bottom: 15px; display:none;"><h3 style="margin:0"><i class="fas fa-save"></i> Sauvegarder</h3></button>
				</div>
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="recGraphContainer" style="height: 41vh;"></div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="recFourierContainer" style="height: 36vh;"></div>
			</div>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!---------------------------------SAVED TAB-------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="savTab" class="w3-row" style="display:none">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Traitement</h3>
				</header>
				<div class="w3-container w3-white">
					<label class="w3-opacity phy-menu-label"><b>Fréquence d'échantillonage</b></label>
					<select id="savSampleRateSelect" class="w3-select" name="option">
					</select> 
				</div>
			</div>
			<!-- Second element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Analyse spectrale</h3>
				</header>
				<div class="w3-container w3-white">
					<button class="w3-button w3-block w3-theme w3-hover-theme2" id="fourierReplotButton" style="margin-top: 15px; margin-bottom: 15px;"><label>Recalculer</label></button>
				</div>
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="savGraphContainer" style="height: 41vh;"></div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="savFourierContainer" style="height: 36vh;"></div>
			</div>
		</div>
	</div>

	<!-------------------------------------------------------------------------->
	<!--------------------------------- MODALS --------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="infoModal" class="w3-modal">
    <div class="w3-modal-content w3-animate-top w3-card-4">
      <header class="w3-container w3-theme2"> 
        <span id="closeInfoButton" class="w3-button w3-display-topright"><i class="fas fa-times"></i></span>
        <h2>À propos</h2>
      </header>
      <div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-info-circle fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Application permettant de générer des spectres RMN (simplistes) suffisamment lisibles pour être intégrés dans des activités, exercices, DS...</p>
					<p>Le site <a href="http://www.nmrdb.org/new_predictor">nmrdb</a> permet d'obtenir le spectre qui vous interesse juste en tracant la molécule.</p>
				</div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fab fa-firefox fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Les applications utilisent des technologies modernes pour fonctionner (HTLM5, CSS et JS). Il est indispensable d'utiliser un navigateur internet récent pour les faire fonctionner. Les applications ont été testés sur Mozilla Firefox et Google Chrome.</p></div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-envelope fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>pro.wal@protonmail.com</p></div>
			</div>
			<div class="w3-light-grey w3-section">
				<button onclick="accordion('licenceAccordion')" class="w3-button w3-block">
					<div class="w3-container w3-cell"><p><i class="fas fa-copyright fa-2x"></i></p></div>
					<div class="w3-container w3-cell"><p>MIT Licence</p></div>
				</button>
				<div id="licenceAccordion" class="w3-hide w3-container">
					<p><script src="lib/licence.js"></script></p>
				</div>
			</div>
    </div>
	</div>
	<!-- Save modal card -->
	<div id="saveModal" class="w3-modal">
		<div class="w3-modal-content w3-animate-top w3-card-4" style="width:400px;">
			<header class="w3-container w3-theme2">
				<h2>Sauvegarder</h2>
			</header>
			<div style="padding: 10px;">
				<span class="w3-container w3-cell" style="width:100%; margin: 10px;">
					<input type="text" class="w3-input w3-border-0" id="saveNameInput" placeholder="Nom de la sauvegarde">
				</span>
				<span id="validateSaveButton" class="w3-button w3-theme w3-hover-theme2 w3-cell" style="width:50px"><i class="fas fa-check"></i></span>
			</div>
		</div>
	</div>

<script>
const $ = document.querySelector.bind(document);

let p1 = 0;
let p2 = 0;
let p3 = 0;

// Declare vars
let rtWaveData = [];
let rtFourierData = [];

let rtWaveChart;
let rtFourierChart;

let recWaveData = [{
  x: [],
  y: [],
  mode: "line",
  name: "TODO",
	line: {
    color: phyColors.theme2,
    width: 3
  }
}];
let recFourierData = [{
  x: [],
  y: [],
  mode: "line",
  name: "TODO",
	line: {
    color: phyColors.theme2,
    width: 3
  }
}];

let savWaveData = [{
  x: [],
	y: [],
  mode: "line",
  name: "TODO",
	line: {
    color: phyColors.theme2,
    width: 3
  }
}];
let savFourierData = [{
  x: [],
  y: [],
  mode: "line",
  name: "TODO",
	line: {
    color: phyColors.theme2,
    width: 3
  }
}];
let bufferSize = 4096;
let rtLength = 0.04;

// Create the Fourier object
let fourier = new Fourier(bufferSize);

// Create a PhyAudio object
let audio = new PhyAudio(bufferSize);

let activeTab;

let isModeBarDisplayed = true;

// Get the default max sample rate from the audio context
let baseSampleRate = audio.getSampleRate();

// rt vars
let rtSampleRate = baseSampleRate;
let rtRecordedSampleRate = baseSampleRate; // The sample was recorded with this sampleRate

let paused = false;
let stabilization = true;

// record vars
let sampleLength = 0.05; // TODO TODO TODO TODO get the actual value from html
let recSampleRate = baseSampleRate; // The sample will be recorded with this sampleRate
let recordedSampleRate; // The sample was recorded with this sampleRate

// save vars
let saves = [];

// Get canvas contexts (rt)
const rtWaveCanvasCtx = $("canvas.rtWaveCanvas").getContext("2d");
const rtFourierCanvasCtx = $("canvas.rtFourierCanvas").getContext("2d");

// Get div elements (sav)
const recWaveGraph = $("#recGraphContainer");
const recFourierGraph = $("#recFourierContainer");

// Get div elements (sav)
let savWaveGraph = $("#savGraphContainer");
let savFourierGraph = $("#savFourierContainer");

// Get sliders elements
const rtAmplificationSlider = $("#rtAmplificationSlider");
const rtAmplificationValue = $("#rtAmplificationValue");
rtAmplificationSlider.addEventListener("input", onRtAmplificationSliderChange);
rtAmplificationSlider.addEventListener("dblclick", onRtAmplificationSliderDblClick);
rtAmplificationValue.addEventListener("dblclick", onRtAmplificationSliderDblClick);

// Get inputs and selects elements
const sampleLengthInput = $("#sampleLengthInput");
sampleLengthInput.addEventListener("input", onSampleLengthInput);

const saveNameInput = $("#saveNameInput");
saveNameInput.addEventListener("keyup", function(event){onSaveNameInputKeyup(event)});

const rtSampleRateSelect = $("#rtSampleRateSelect");
rtSampleRateSelect.addEventListener("change", onRtSampleRateSelectChange);

const recSampleRateSelect = $("#recSampleRateSelect");
recSampleRateSelect.addEventListener("change", onRecSampleRateSelectChange);

const savSampleRateSelect = $("#savSampleRateSelect");
savSampleRateSelect.addEventListener("change", onSavSampleRateSelectChange);

// Get the tab bar and tab buttons elements
const tabBar = $("#tabBar");

let tabButtons = [];
tabButtons[0] = $("#rtTabButton");
tabButtons[1] = $("#recTabButton");
tabButtons[0].addEventListener("click", function(){onTabButtonClick(0)});
tabButtons[1].addEventListener("click", function(){onTabButtonClick(1)});

let tabs = [];
tabs[0] = $("#rtTab");
tabs[1] = $("#recTab");
tabs[2] = $("#savTab");

// Get buttons elements
const pauseButton = $("#pauseButton");
pauseButton.addEventListener("click", onPauseButtonClick);

const rtSaveButton = $("#rtSaveButton");
rtSaveButton.addEventListener("click", onRtSaveButtonClick);

const sampleButton = $("#sampleButton");
sampleButton.addEventListener("click", onSampleButton);

const recSaveButton = $("#recSaveButton");
recSaveButton.addEventListener("click", onRecSaveButtonClick);

const validateSaveButton = $("#validateSaveButton");
validateSaveButton.addEventListener("click", onValidateSaveButtonClick);

const fourierReplotButton = $("#fourierReplotButton");
fourierReplotButton.addEventListener("click", onFourierReplotButtonClick);

const infoButton = $("#infoButton");
infoButton.addEventListener("click", onInfoButtonClick);

const closeInfoButton = $("#closeInfoButton");
closeInfoButton.addEventListener("click", onCloseInfoButtonClick);

populateSampleRateSelect(recSampleRateSelect, 1, 16);
populateSampleRateSelect(rtSampleRateSelect, 1, 2);


/*----------------------------------------------------------------------------------------------
-----------------------------------------GRAPH SETTINGS-----------------------------------------
----------------------------------------------------------------------------------------------*/

let rtGraphConfig = {
	type: "line",
	data: {
		datasets: [{
			label: "TODO",
			borderColor: phyColors.theme2,
			// Hides the points...
			radius: 0,
			fill: false
		}]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false,
		},
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Temps (s)"
				},
				ticks: {
					min: 0,
					max: rtLength,
					//autoSkip: true,
					//maxTicksLimit: 10,
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: "Amplitude"
				},
				ticks: {
					suggestedMin: -1,
					suggestedMax: 1,
				}
			}]
		}
	}
};

let rtFourierConfig = {
	type: "line",
	data: {
		datasets: [{
			label: "TODO",
			borderColor: phyColors.theme2,
			// Hides the points...
			radius: 0,
			fill: false
		}]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false,
		},
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Fréquence (Hz)"
				},
				ticks: {
					min: 0,
					max: 10000,
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: "Amplitude"
				},
				ticks: {
					suggestedMin: 0,
					suggestedMax: 0.5,
				}
			}]
		}
	}
};

let recGraphConfig = {
	autosize: true,
	font: { // Copy fron chart.js default
    family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",
    size: 12,
    color: '#666'
  },
  xaxis: {
    title: "Temps (s)",
		titlefont: {size: 12},
		tickmode: "auto",
		nticks: 11,
		range: [0, 0.05]
  },
  yaxis: {
    title: "Amplitude",
		titlefont: {size: 12},
		tickmode: "auto",
		nticks: 11,
		range: [-1, 1]
  },
	margin: {
    l: 40,
    r: 16,
    b: 35,
    t: 25,
    pad: 2
  }
};

let recFourierConfig = {
	autosize: true,
	font: { // Copy fron chart.js default
    family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",
    size: 12,
    color: '#666'
  },
  xaxis: {
		title: "Fréquence (Hz)",
		titlefont: {size: 12},
		tickformat : "r",
		range: [0, 10000]
  },
  yaxis: {
		title: "Amplitude",
		titlefont: {size: 12},
		range: [0, 0.5]
  },
	margin: {
    l: 40,
    r: 16,
    b: 35,
    t: 25,
    pad: 2
  }
};

let savGraphConfig = {
	autosize: true,
	font: { // Copy fron chart.js default
    family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",
    size: 12,
    color: '#666'
  },
  xaxis: {
    title: "Temps (s)",
		titlefont: {size: 12},
		tickmode: "auto",
		nticks: 11,
		range: [0, 0.05]
  },
  yaxis: {
    title: "Amplitude",
		titlefont: {size: 12},
		tickmode: "auto",
		nticks: 11,
		range: [-1, 1]
  },
	margin: {
    l: 45,
    r: 16,
    b: 35,
    t: 25,
    pad: 2
  }
};

let savFourierConfig = {
	autosize: true,
	font: { // Copy fron chart.js default
    family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",
    size: 12,
    color: '#666'
  },
  xaxis: {
		title: "Fréquence (Hz)",
		titlefont: {size: 12},
		tickformat : "r",
		range: [0, 10000]
  },
  yaxis: {
		title: "Amplitude",
		titlefont: {size: 12},
		range: [0, 0.5]
  },
	margin: {
    l: 45,
    r: 16,
    b: 35,
    t: 25,
    pad: 2
  }
};
/*----------------------------------------------------------------------------------------------
------------------------Create the rec and sav graphs and link the datas------------------------
----------------------------------------------------------------------------------------------*/
Plotly.react(recWaveGraph, recWaveData, recGraphConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
Plotly.react(recFourierGraph, recFourierData, recFourierConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});

Plotly.react(savWaveGraph, savWaveData, savGraphConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
Plotly.react(savFourierGraph, savFourierData, savFourierConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});

/*----------------------------------------------------------------------------------------------
-----------------------------------------DRAW FUNCTIONS-----------------------------------------
----------------------------------------------------------------------------------------------*/
function realtimeDraw() {
	if(paused == false){
	rtWaveData.length = 0;

	// sample
	let graphData = audio.getGraph();

	// Get the chosen sample rate
	rtSampleRate = rtSampleRateSelect.value;

	// Set the new datas
	for(let i = 0; i < graphData.length; i++){
		rtWaveData[i] = {x: i / rtSampleRate, y: graphData[i] /*/ 128.0 - 1*/};
	}

	// Apply chosen sampleRate
	modifySampleRate(rtWaveData, baseSampleRate, rtSampleRate);

	// Compute the fourier
	let fourierData = fourier.computeNormalizedFft(rtWaveData, rtSampleRate, false);

	// Trim unnecessary data
	let trimedRtWaveData = arrayOfPointsCopy(rtWaveData);

	if(stabilization == true){
		stabilize(trimedRtWaveData);
	}
	trimedRtWaveData.splice(rtLength * rtSampleRate);
	// Set the new fourier datas
	rtFourierData = arrayOfPointsCopy(fourierData, rtWaveData.length / rtSampleRate * 10000);

	rtWaveChart.data.datasets[0].data = trimedRtWaveData;
	rtWaveChart.update();
	rtFourierChart.data.datasets[0].data = rtFourierData;
	rtFourierChart.update();
	};
}

function recordDraw() {
	// sample
	if(audio.isDataAvailable() == true){
		// Discard old datas
		recWaveData[0].x.length = 0;
		recWaveData[0].y.length = 0;
		recFourierData[0].x.length = 0;
		recFourierData[0].y.length = 0;

		// Get the recorded datas
		let graphData = audio.getRecord();

		let fftInput = [];

		// Apply chosen sampleRate
		modifySampleRate(graphData, baseSampleRate, recSampleRate);

		// Set the new datas
		for(let i = 0; i < sampleLength * recSampleRate; i++){
			recWaveData[0].x[i] = i / recSampleRate;
			recWaveData[0].y[i] = graphData[i];
		}

		// Ugly hack to force plotly to redraw
		if(recGraphConfig.datarevision == 1){
			recGraphConfig.datarevision = 0;
			recFourierConfig.datarevision = 0;
		}
		else{
			recGraphConfig.datarevision = 1;
			recFourierConfig.datarevision = 1;
		}
		//Draw the wave
		Plotly.react(recWaveGraph, recWaveData, recGraphConfig);

		// Compute and plot the dft
		computePlotlyFourier(recWaveData[0], recFourierData[0], recSampleRate);
		Plotly.react(recFourierGraph, recFourierData, recFourierConfig);
	}
}

function saveDraw() {
	// Flush previous datas
	savWaveData[0].x.length = 0;
	savWaveData[0].y.length = 0;
	savFourierData[0].x.length = 0;
	savFourierData[0].y.length = 0;

	// Set new datas
	savWaveData[0].x = saves[activeTab-2].x.slice();
	savWaveData[0].y = saves[activeTab-2].y.slice();
	savFourierData[0].x = saves[activeTab-2].fx.slice();
	savFourierData[0].y = saves[activeTab-2].fy.slice();

	// Populate the sample rate 
	populateSampleRateSelect(savSampleRateSelect, saves[activeTab-2].recordedSampleRateLvl, 32);
	// Select the right option
	savSampleRateSelect.selectedIndex = Math.log2(saves[activeTab-2].displaySampleRateLvl) - Math.log2(saves[activeTab-2].recordedSampleRateLvl);

	// Apply the selected display sample rate
	modifySampleRate(savWaveData[0].x, baseSampleRate / saves[activeTab-2].recordedSampleRateLvl, baseSampleRate / saves[activeTab-2].displaySampleRateLvl);
	modifySampleRate(savWaveData[0].y, baseSampleRate / saves[activeTab-2].recordedSampleRateLvl, baseSampleRate / saves[activeTab-2].displaySampleRateLvl);

	// Apply zoom
	savWaveGraph.layout.xaxis.autorange ="false"; // In case  the autoscale button was pressed
	savWaveGraph.layout.yaxis.autorange ="false";
	savWaveGraph.layout.xaxis.range = arrayCopy(saves[activeTab-2].range.xRange);
	savWaveGraph.layout.yaxis.range = arrayCopy(saves[activeTab-2].range.yRange);
	savFourierGraph.layout.xaxis.autorange ="false"; // In case  the autoscale button was pressed
	savFourierGraph.layout.yaxis.autorange ="false";
	savFourierGraph.layout.xaxis.range = arrayCopy(saves[activeTab-2].fourierRange.xRange);
	savFourierGraph.layout.yaxis.range = arrayCopy(saves[activeTab-2].fourierRange.yRange);

	// Ugly hack to force plotly to redraw
	if(savGraphConfig.datarevision == 1){
		savGraphConfig.datarevision = 0;
		savFourierConfig.datarevision = 0;
	}
	else{
		savGraphConfig.datarevision = 1;
		savFourierConfig.datarevision = 1;
	}

	// Draw the wave
	Plotly.react(savWaveGraph, savWaveData, savGraphConfig);
	Plotly.react(savFourierGraph, savFourierData, savFourierConfig);
}

function draw() {
	requestAnimationFrame(draw);
	switch(activeTab){
	case 0:
		realtimeDraw();
		break;
	case 1:
		recordDraw();
		break;
	default:
		//saveDraw();
	}
};

/*----------------------------------------------------------------------------------------------
-------------------------------------DEEP COPY FUNCTIONS----------------------------------------
----------------------------------------------------------------------------------------------*/
function arrayCopy(_array, _length = _array.length){
	let copy = [];
	for(let i = 0; i < _length; i++){
		copy[i] = _array[i];
	}
	return copy;
}

function arrayOfPointsCopy(_array, _length = _array.length){
	let copy = [];
	for(let i = 0; i < _length; i++){
		copy[i] = {x: _array[i].x, y:_array[i].y};
	}
	return copy;
}

/*----------------------------------------------------------------------------------------------
-----------------------------------COMPUTE PLOTLY FOURIER---------------------------------------
----------------------------------------------------------------------------------------------*/
function computePlotlyFourier(_wave, _result, _sampleRate, _range){
	let startIndex;
	let stopIndex;
	if(_range == undefined){
		startIndex = 0;
		stopIndex = _wave.x.length;
	}
	else{
		startIndex = Math.floor(_range[0] * _sampleRate);
		stopIndex = Math.floor(_range[1] * _sampleRate);
	}
	let fftData = {x:[], y:[]};
	// Change data format to be able to perform fft on it
	let fftInput = [];
	for(let i = startIndex; i < stopIndex; i++){
		fftInput[i - startIndex] = {x: _wave.x[i], y: _wave.y[i]};
	}
	// Compute the dft
	let dftResult = fourier.computeNormalizedFft(fftInput, _sampleRate, false)

	// limit dft to 10 kHz  
	let maxIndex = dftResult.length;
	if(_sampleRate / 2 > 10000){
		maxIndex = dftResult.length / _sampleRate * 2 * 10000;
	}
	// Construct the result
	for(let i = 0; i < maxIndex; i++){
		_result.x[i] = dftResult[i].x;
		_result.y[i] = dftResult[i].y;
	}
	return fftData;
}

/*----------------------------------------------------------------------------------------------
-------------------------------------MODIFY SAMPLE RATE-----------------------------------------
----------------------------------------------------------------------------------------------*/
function modifySampleRate(_wave, _initialSampleRate, _targetSampleRate){
	// End function if target = initial
	if(_initialSampleRate === _targetSampleRate){
		return;
	}

	let factor = _initialSampleRate / _targetSampleRate;
	let l = _wave.length;
	let a = l / factor;
	for(let i = 0; i < a; i++){
		_wave[i] = _wave[i * factor];
	}
	_wave.splice(l / factor, l * (factor - 1) / factor);
}
/*----------------------------------------------------------------------------------------------
---------------------------------POPULATE SAMPLERATE SELECT-------------------------------------
----------------------------------------------------------------------------------------------*/
function populateSampleRateSelect(_select, _initLvl = 1, _l = 4){
	// Remove all previous options
	while (_select.firstChild) {
    _select.removeChild(_select.firstChild);
	}
	// Populate sampleRate selects based on baseSampleRate
	for (let i = _initLvl; i <= _l; i = i * 2) {
		let option = document.createElement("option");
		option.value = baseSampleRate / i;
		option.text = (baseSampleRate / i).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " Hz";
		_select.add(option);
	}
}

/*----------------------------------------------------------------------------------------------
-------------------------------TOGGLE MODEBAR (PLOTLY BUGFIX)-----------------------------------
----------------------------------------------------------------------------------------------*/
function toggleModeBar(){
	if(isModeBarDisplayed == true){
		if(activeTab == 1){
			Plotly.react(recWaveGraph, recWaveData, recGraphConfig, {displayModeBar: false});
			Plotly.react(recFourierGraph, recFourierData, recFourierConfig, {displayModeBar: false});
		}
		if(activeTab > 1){
			Plotly.react(savWaveGraph, recWaveData, recGraphConfig, {displayModeBar: false});
			Plotly.react(savFourierGraph, recFourierData, recFourierConfig, {displayModeBar: false});
		}
		isModeBarDisplayed = false;
	}
	else{
		if(activeTab == 1){
			Plotly.react(recWaveGraph, recWaveData, recGraphConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
			Plotly.react(recFourierGraph, recFourierData, recFourierConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
		}
		if(activeTab > 1){
			Plotly.react(savWaveGraph, recWaveData, recGraphConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
			Plotly.react(savFourierGraph, recFourierData, recFourierConfig, {responsive: true, displaylogo: false, displayModeBar: true, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
		}
		isModeBarDisplayed = true;
	}
}

/*----------------------------------------------------------------------------------------------
------------------------------------POPULATE TABS FUNCTION--------------------------------------
----------------------------------------------------------------------------------------------*/
function populateTabs(){
	// Remove all tabs in the tabBar and the tabButtons array
	let tabElements = document.getElementsByClassName("savTab");
	while(tabElements.length > 0){
		tabElements[0].parentNode.removeChild(tabElements[0]);
	}
	tabButtons.splice(2,tabButtons.length - 2);
	// Populate the tabBar
	for(let i = 0; i < saves.length; i++){
	// Add a tab button in the tabBar
	let newButton = document.createElement("span"); // span because we nest a button in it
	let firstHalf = document.createElement("span");
	let secondHalf = document.createElement("span");

	// Add the icon
	let audioFileIcon = document.createElement("i");
	audioFileIcon.className ="fas fa-file-audio";
	firstHalf.appendChild(audioFileIcon);
	
	// Set the button's text
	let newText = document.createTextNode(" " + saves[i].name);
	firstHalf.appendChild(newText);

	// Set the delete button's icon
	let closeIcon = document.createElement("i");
	closeIcon.className ="fas fa-times";
	secondHalf.appendChild(closeIcon);
	
	newButton.className ="w3-bar-item savTab phy-tab w3-hover-none";
	firstHalf.className ="w3-button w3-hover-none phy-tab-alt";
	secondHalf.className ="w3-button w3-hover-none phy-tab-close-button";

	newButton.style.padding = 0;

	newButton.appendChild(firstHalf);
	newButton.appendChild(secondHalf);
	tabBar.appendChild(newButton);

	// Set the callbacks
	tabButtons[i + 2] = newButton;
	firstHalf.addEventListener("click", function(){onTabButtonClick(i + 2)});
	secondHalf.addEventListener("click", function(){onTabCloseButtonClick(i)});
	}
}

/*----------------------------------------------------------------------------------------------
--------------------------------------STABILIZE FUNCTION----------------------------------------
----------------------------------------------------------------------------------------------*/
function stabilize(_data){
	let maximum = 0;
	let maximumIndex = 0;
	for(let i = 0; i < _data.length / 10; i++){
		if(_data[i].y > maximum){
			maximum = _data[i].y;
			maximumIndex = i;
		}
	}

	for(let i = 0; i < _data.length - maximumIndex; i++){
		_data[i + maximumIndex].x = i / rtSampleRate;
	}
	_data.splice(0,maximumIndex);
}

/*----------------------------------------------------------------------------------------------
---------------------------------------PLOTLY ZOOM EVENTS---------------------------------------
----------------------------------------------------------------------------------------------*/
savWaveGraph.on("plotly_relayout",
	function(eventdata){
		// Store the current zoom range if the current tab is a sav
		if(activeTab > 1){
			saves[activeTab-2].range.xRange = arrayCopy(savWaveGraph.layout.xaxis.range);
			saves[activeTab-2].range.yRange = arrayCopy(savWaveGraph.layout.yaxis.range);
		}
	}
);

savFourierGraph.on("plotly_relayout",
	function(eventdata){
		// Store the current zoom range if the current tab is a sav
		if(activeTab > 1){
			saves[activeTab-2].fourierRange.xRange = arrayCopy(savFourierGraph.layout.xaxis.range);
			saves[activeTab-2].fourierRange.yRange = arrayCopy(savFourierGraph.layout.yaxis.range);
		}
	}
);

/*----------------------------------------------------------------------------------------------
---------------------------------------------EVENTS---------------------------------------------
----------------------------------------------------------------------------------------------*/
function onPauseButtonClick() {
	if(paused == true){
		paused = false;
		pauseButton.classList.remove("w3-red");
		pauseButton.classList.add("w3-white");
		// Hide the record button
		rtSaveButton.style.display = "none";
	}
	else{
		paused = true;
		pauseButton.classList.remove("w3-white");
		pauseButton.classList.add("w3-red");
		// Show the record button
		rtSaveButton.style.display = "block";
	}
}

function onRtSaveButtonClick() {
	// Display save modal
	$("#saveModal").style.display="block";

	// Focus the input
	saveNameInput.focus();

	// Hides the modebar while the modal is active (plotly bug)
	toggleModeBar();
}

function onRecSaveButtonClick() {
	// Display save modal
	$("#saveModal").style.display="block";

	// Focus the input
	saveNameInput.focus();

	// Hides the modebar while the modal is active (plotly bug)
	toggleModeBar();

	// TODO Merge with onRtSaveButtonClick ?
}

function onValidateSaveButtonClick() {
	// Get the save name
	let text;
	if(saveNameInput.value == ""){
		text = "Enreg.";
	}
	else{
		text = saveNameInput.value;
	}

	if(activeTab == 0){
		// Convert point format to plotly
		let tmpx = [];
		let tmpy = [];
		let tmpfx = [];
		let tmpfy = [];
		for(let i = 0; i < rtWaveData.length; i++){
			tmpx[i] = rtWaveData[i].x;
			tmpy[i] = rtWaveData[i].y;
		}
		for(let i = 0; i < rtFourierData.length; i++){
			tmpfx[i] = rtFourierData[i].x;
			tmpfy[i] = rtFourierData[i].y;
		}
		saves.push({
			name: text,
			x: tmpx,
			y: tmpy,
			fx: tmpfx,
			fy: tmpfy,
			recordedSampleRateLvl: baseSampleRate / rtSampleRate,
			displaySampleRateLvl: baseSampleRate / rtSampleRate,
			range: {xRange: [0, tmpx[tmpx.length - 1]], yRange: [-1, 1]},
			fourierRange: {xRange: [0, 10000], yRange: [0, 0.5]},
			fourierPlottingRange: [0, tmpx[tmpx.length - 1]],
		});
	}
	else{
		// save the datas
		let tmpx = arrayCopy(recWaveData[0].x);
		let tmpy = arrayCopy(recWaveData[0].y);

		let tmpfx = arrayCopy(recFourierData[0].x);
		let tmpfy = arrayCopy(recFourierData[0].y);
		
		saves.push({
			name: text,
			x: tmpx,
			y: tmpy,
			fx: tmpfx,
			fy: tmpfy,
			recordedSampleRateLvl: baseSampleRate / recordedSampleRate,
			displaySampleRateLvl: baseSampleRate / recordedSampleRate,
			range: {xRange: [0, tmpx[tmpx.length - 1]], yRange: [-1, 1]},
			fourierRange: {xRange: [0, 10000], yRange: [0, 0.5]},
			fourierPlottingRange: [0, tmpx[tmpx.length - 1]],
		});
	}

	// Redraw tabs
	populateTabs();

	// Empty the input and hide the modal card
	saveNameInput.value = "";
	$("#saveModal").style.display="none";

	// Show the modebar again (plotly bug)
	toggleModeBar();
}

function onSaveNameInputKeyup(event){
	// Cancel the default action, if needed
	event.preventDefault();
	// Number 13 is the "Enter" key on the keyboard
	if (event.keyCode === 13) {
	// Click on validate
	onValidateSaveButtonClick();
  }
}

function onFourierReplotButtonClick() {
	// Save the ranges
	saves[activeTab-2].range.xRange = arrayCopy(savWaveGraph.layout.xaxis.range);
	saves[activeTab-2].range.yRange = arrayCopy(savWaveGraph.layout.yaxis.range);

	saves[activeTab-2].fourierPlottingRange = savWaveGraph.layout.xaxis.range;
	let dftResult = {x:[], y:[]};
	computePlotlyFourier(savWaveData[0], dftResult, baseSampleRate / saves[activeTab-2].displaySampleRateLvl, saves[activeTab-2].fourierPlottingRange);
	saves[activeTab-2].fx = dftResult.x;
	saves[activeTab-2].fy = dftResult.y;
	saveDraw();
}

function onSampleButton() {
	// SampleLength value verifications
	if(sampleLengthInput.value === ""){
		alert("La durée d'enregistrement n'est pas un nombre valide.");
		return;
	}
	if(sampleLengthInput.value < 0.01){
		alert("La durée d'enregistrement minimale est de 0,01 s.");
		return;
	}
	if(sampleLengthInput.value > 30){
		alert("La durée d'enregistrement maximale est de 30 s.");
		return;
	}
	// Record new datas
	audio.startRecording(sampleLength);

	// Save the sampleRate used
	recordedSampleRate = recSampleRate;

	// Display the save button
	recSaveButton.style.display ="block";
	sampleButton.style.marginBottom = "0px";
}

function onSampleLengthInput() {
	// TODO Add checks!
	sampleLength = sampleLengthInput.value;
	// Set graph axes range
	recGraphConfig.xaxis.range[1] = sampleLength;
}

function onRtSampleRateSelectChange() {
	// Empty TODO
}

function onRecSampleRateSelectChange() {
	recSampleRate = recSampleRateSelect.value;
}

function onSavSampleRateSelectChange() {
	saves[activeTab-2].displaySampleRateLvl = baseSampleRate / savSampleRateSelect.value;
	saveDraw();
}

function onTabButtonClick(_id) {
	// Store the activeTab id
	activeTab = _id;

	// UnActivate all buttons
	for(let i = 0; i < tabButtons.length; i++){
		tabButtons[i].classList.remove("phy-tab-active");
	}
	// Activate the clicked button
	tabButtons[_id].classList.add("phy-tab-active");

	// Hide all tabs
	for(let i = 0; i < tabs.length; i++){
		tabs[i].style.display = "none";
	}

	// Show the active tab
	if(_id > 1){
		tabs[2].style.display = "block";

		// Draw the active sav tab
		saveDraw();
	}
	else{
		tabs[_id].style.display = "block";
	}

	// Draw the graphs if the record tab is active
	if(activeTab == 1){
		Plotly.react(recWaveGraph, recWaveData, recGraphConfig);
		Plotly.react(recFourierGraph, recFourierData, recFourierConfig);
	}
}

function onTabCloseButtonClick(_id) {
	tabButtons[_id+2].classList.add("phy-fadeout");
	setTimeout(function(){
		// Delete tab datas
		saves.splice(_id,1);
		// Populate tabs
		populateTabs();
		// Active the active tab (duh)
		if(activeTab > _id + 1){
			activeTab = activeTab - 1;
			onTabButtonClick(activeTab);
		}
		else{
			onTabButtonClick(activeTab);
		}
	}, 250);
}

function onRtAmplificationSliderChange() {
	audio.setGain(rtAmplificationSlider.value / 10); // /10 to have integer values in the slider
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

function onRtAmplificationSliderDblClick() {
	audio.setGain(1); // Default
	rtAmplificationSlider.value = 10;
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

function onInfoButtonClick() {
	$("#infoModal").style.display="block";

	// Hides the modebar while the modal is active (plotly bug)
	toggleModeBar();
}

function onCloseInfoButtonClick(){
	$("#infoModal").style.display="none";

	// Show the modebar (plotly bug)
	toggleModeBar();
}

window.onload = function() {
	// Create the rt graph and link the datas
	rtWaveChart = new Chart(rtWaveCanvasCtx, rtGraphConfig);
	rtFourierChart = new Chart(rtFourierCanvasCtx, rtFourierConfig);

	// Init the rt gain slider
	onRtAmplificationSliderChange()

	// Activate a tab
	onTabButtonClick(0);

	draw();
};

</script>
</body>
</html> 