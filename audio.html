<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 
	MIT License

	La Belle Physique : Analyseur audio

	Copyright (c) 2019 Gaétan Walter

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->

	<title>Analyseur audio</title>
	<link rel="icon" href="img/audio.ico" />

	<link rel="stylesheet" href="lib/w3.css">
	<link rel="stylesheet" href="lib/w3-theme-teal.css"> 
	<link rel="stylesheet" href="lib/w3-theme-indigo.css"> 

	<link rel="stylesheet" href="lib/fontawesome/css/all.min.css">

	<link rel="stylesheet" href="lib/phy.css">

	<script src="lib/highcharts/highcharts.js"></script>
	<script src="lib/highcharts/highcharts-heatmap.js"></script>
	<script src="lib/highcharts/boost.js"></script>

	<script src="lib/phy.js"></script>
	<script src="lib/common.js"></script>

	<script src="lib/audio.js"></script>

	<script src="lib/fourier.js"></script>

</head>
<body class="w3-light-grey">
	<!-- Header bar -->
	<div class="w3-card-4 w3-white">
		<script>headerWrite("Analyseur audio");</script>
		<div id="tabBar" class="w3-bar">
			<button id ="rtTabButton" class="w3-bar-item w3-button w3-hover-none w3-padding-small phy-tab">TEMPS REEL</button>
			<button id ="recTabButton" class="w3-bar-item w3-button w3-hover-none w3-padding-small phy-tab">ACQUISITION</button>
			<span class="w3-bar-item w3-opacity w3-padding-small"><i class="fas fa-minus fa-rotate-90"></i></span>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!-------------------------------REALTIME TAB------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="rtTab" class="w3-row">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Paramètres</h3>
				</header>
				<div class="w3-white" style="overflow:hidden">
					<div class="w3-panel">
						<label class="phy-menu-label">Amplification</label>
						<input class="range-slider_range" id="rtAmplificationSlider" type="range" value="1" min="0" max="2" step="0.1">
						<span class="range-slider_value" id="rtAmplificationValue">x 1</span>
					</div>
				</div>
			</div>
			<!-- Second element -->
			<div class="w3-card-4 phy-menu-element w3-white" >
				<button class="w3-button w3-block w3-xlarge w3-hover-red" id="pauseButton"><i class="fas fa-pause"></i> Pause</button>
				<button class="w3-button w3-block w3-xlarge" id="rtSaveButton" style="display:none"><i class="fas fa-save"></i> Sauvegarder</button>
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="rtGraphContainer" style="height: calc(55vh - 78px)">
					<!--<canvas class="rtWaveCanvas"></canvas>-->
				</div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="rtFourierContainer" style="height: calc(45vh - 78px)">
				<!--	<canvas class="rtFourierCanvas"></canvas>-->
				</div>
			</div>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!--------------------------------RECORD TAB-------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="recTab" class="w3-row" style="display:none">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Acquisition</h3>
				</header>
				<div id="tabBar" class="w3-bar w3-white">
					<button id ="sampleTabButton" class="w3-half w3-button w3-hover-none phy-tab">Micro</button>
					<button id ="fileTabButton" class="w3-half w3-button w3-hover-none phy-tab">Fichier</button>
				</div>
				<!-- Sample tab -->
				<div id="sampleTab" class="w3-white" style="overflow:hidden">
					<div class="w3-panel">
						<label class="phy-menu-label">Durée d'acquisition</label>
						<input type="number" class="w3-input" id="sampleLengthInput" value="0.05" step="0.01" min="0.01" max="30">
					</div>
					<div class="w3-panel">
						<label class="phy-menu-label">Fréquence d'échantillonage</label>
						<select id="recSampleRateSelect" class="w3-select"></select>
					</div>
					<div class="w3-panel">
						<button class="w3-button w3-block w3-xlarge w3-theme w3-hover-theme2" id="sampleButton" >
							<i class="fas fa-microphone"></i> Acquisition
						</button>
						<div id="recProgressBarContainer" class="w3-display-container w3-theme" id="sampleButton" style="display: none;">
							<div id="recProgressBarLabel" class="w3-display-middle w3-xlarge" style="display: none;">00:00</div>
							<div id="recProgressBar" class="w3-theme2 w3-center" style="height:52px;"></div>
						</div>
					</div>
				</div>
				<!-- File tab -->
				<div id="fileTab" class="w3-white" style="overflow:hidden">
					<div class="w3-panel">
						<input type="file" accept="audio/*" id="fileInput" class="inputfile">
						<label class="w3-button w3-block w3-xlarge w3-theme w3-hover-theme2 " id="inputFileButton" for="fileInput" >
							<i class="fas fa-file-upload"></i> Parcourir ...
						</label>
						<label class="w3-container w3-padding w3-block w3-xlarge w3-center w3-theme " id="inputFileDecodingLabel" style="display:none;">
							<i class="fas fa-spinner fa-spin"></i> Chargement ...
						</label>
						<div class="w3-border" id="fileInputResult" style="display:none;">
							<div class="w3-container" style="width: 80%"><p id="fileInputLabel">FICHIER</p></div>
							<button class="w3-theme w3-button" id="fileInputResultDiscardButton" style="flex: 1; padding:0px;"><i class="fas fa-times"></i></button>
						</div>
					</div>
				</div>
			</div>
			<!-- Second element -->
			<div id="recSampleContainer" class="w3-card-4 phy-menu-element w3-white" style="display:none;">
				<header class="w3-bar w3-container w3-theme2">
					<h3 class="w3-bar-item" style="padding: 0px;">Enregistrement </h3>
					<h3 id="recSampleLengthLabel" class="w3-bar-item w3-right" style="padding: 0px;"></h3>
				</header>
				<button class="w3-button w3-block w3-xlarge" id="recPlayButton" ></button>
				<button class="w3-button w3-block w3-large" id="recSaveButton">
						<span class="w3-cell w3-cell-middle" style="width:50px"><i class="fas fa-bookmark w3-xlarge"></i></span>
						<span class="w3-cell w3-xlarge">Sauvegarder<br>dans un onglet</span>
				</button>
				<!-- 	<span><i class="fas fa-save w3-xlarge"></i></span><span>Sauvegarder<br>en fichier audio</span>-->
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="recGraphContainer" style="height: calc(55vh - 78px)"></div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="recFourierContainer" style="height: calc(45vh - 78px)"></div>
			</div>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!---------------------------------SAVED TAB-------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="savTab" class="w3-row" style="display:none">
		<!-- Second column -->
		<div class="w3-col w3-right" style="width:300px">
			<!-- First element -->
			<div class="w3-card-4 phy-menu-element">
				<header class="w3-container w3-theme">
					<h3>Traitement</h3>
				</header>
				<div class="w3-white" style="overflow:hidden">
					<div class="w3-panel">
						<label class="phy-menu-label">Fréquence d'échantillonage</label>
						<select id="savSampleRateSelect" class="w3-select"></select> 
					</div>
				</div>
			</div>
			<!-- Second element -->
			<div id="fourierCard" class="w3-card-4 phy-menu-element w3-white" style="overflow:hidden">
				<header class="w3-container w3-theme">
					<h3>Analyse spectrale</h3>
				</header>
				<div class="w3-panel">
					<label class="phy-menu-label">Type d'analyse spectrale</label>
					<div>
						<input class="w3-radio" type="radio" name="fourierType" id="fourierTypeChoice0" value="0" checked>
						<label for="fourierTypeChoice0">Normale</label>
						<br>
						<input class="w3-radio" type="radio" name="fourierType" id="fourierTypeChoice1" value="1">
						<label for="fourierTypeChoice1">Temporelle</label>
					</div>
					<!--<div>
						<input class="w3-radio" type="radio" name="fourierType" value="1">
						<label>Temporelle</label>
					</div>-->
				</div>
				<div class="w3-panel">
					<button class="w3-button w3-block w3-xlarge w3-theme w3-hover-theme2" id="fourierReplotButton" >
						<i class="fas fa-calculator"></i> Recalculer
					</button>
				</div>
			</div>
			<!-- Third element -->
			<div class="w3-card-4 phy-menu-element w3-white">
				<header class="w3-bar w3-container w3-theme2">
					<h3 class="w3-bar-item" style="padding: 0px;">Enregistrement </h3>
					<h3 id="savSampleLengthLabel" class="w3-bar-item w3-right" style="padding: 0px;"></h3>
				</header>
				<button class="w3-button w3-block w3-xlarge" id="savPlayButton"></button>
				<button class="w3-button w3-block w3-large" id="downloadButton">
						<span class="w3-cell w3-cell-middle" style="width:50px"><i class="fas fa-save w3-xlarge"></i></span>
						<span class="w3-cell w3-xlarge">Sauvegarder<br>en fichier audio</span>
				</button>
			</div>
		</div>
		<!-- First column -->
		<div class="w3-rest">
			<!-- First graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white">
				<div id="savGraphContainer" style="height: calc(55vh - 78px)"></div>
			</div>
			<!-- Second graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white" id="savRegularFourierCard">
				<div id="savFourierContainer" style="height: calc(45vh - 78px)"></div>
			</div>
			<!-- Third graph -->
			<div class="w3-card-4 w3-margin w3-padding w3-white" id="savTemporalFourierCard" style="display:none">
				<div id="savTemporalFourierContainer" style="height: calc(45vh - 78px)"></div>
			</div>
		</div>
	</div>

	<!-------------------------------------------------------------------------->
	<!--------------------------------- MODALS --------------------------------->
	<!-------------------------------------------------------------------------->
	<script>modalWrite("audio");</script>
	<!-- Save modal card -->
	<div id="saveModal" class="w3-modal">
		<div class="w3-modal-content w3-animate-top w3-card-4" style="width:400px;">
			<header class="w3-container w3-theme2">
				<h2>Sauvegarder</h2>
			</header>
			<div class="w3-padding">
				<span class="w3-container w3-cell" style="width:100%;">
					<input type="text" class="w3-input" id="saveNameInput" placeholder="Nom de la sauvegarde">
				</span>
				<span id="validateSaveButton" class="w3-button w3-theme w3-hover-theme2 w3-cell"><i class="fas fa-check"></i></span>
			</div>
		</div>
	</div>
	<!-- file modal card -->
	<div id="fileModal" class="w3-modal">
		<div class="w3-modal-content w3-animate-top w3-card-4" style="width:400px;">
			<header class="w3-container w3-theme2">
				<h2>Fichier trop long</h2>
			</header>
			<div class="w3-padding">
				<span class="w3-container w3-cell" style="width:100%;">
					Le fichier est trop long, seules les 20 premières secondes ont été chargées.
				</span>
				<span id="validateFileButton" class="w3-button w3-theme w3-hover-theme2 w3-cell"><i class="fas fa-check"></i></span>
			</div>
		</div>
	</div>
	<!-- intro modal card -->
	<div id="introModal" class="w3-modal">
		<div class="w3-modal-content w3-animate-top w3-card-4" style="width:600px;">
			<header class="w3-container w3-theme2">
				<h2>Choisissez une configuration</h2>
			</header>
			<div class="w3-padding">
				<span id="simpleModeButton" class="w3-button w3-theme w3-hover-theme2 w3-large" style="width: 280px">Mode simple<br>(Sans analyse fréquentielle)</span>
				<span id="fullModeButton" class="w3-button w3-theme w3-hover-theme2 w3-large" style="width: 280px">Mode complet<br>(Avec analyse fréquentielle)</span>
			</div>
		</div>
	</div>

<script>
const $ = document.querySelector.bind(document);

// simpleMode enabled?
let simpleMode = false;

// Declare vars
let rtWaveData;
let recWaveData;

const rtBasebufferSize = 4096;
const rtLength = 0.04;
const chunkLength = 0.1;

// True if the rt graph needs to be fully drawn
let rtInitialDraw = true;

// Create fourier, PhyAudio and fileReader objects
let fourier = new Fourier(rtBasebufferSize);
let audio = new PhyAudio(rtBasebufferSize);
let fileReader = new FileReader();
fileReader.addEventListener("loadend", onFileReaderLoadEnd);

let activeTab;

// Get the default max sample rate from the audio context
let baseSampleRate = audio.getSampleRate();

// rt vars
let paused = true;

// record vars
let sampleLength = parseFloat($("#sampleLengthInput").value);
let recSampleRate = baseSampleRate; // The sample will be recorded with this sampleRate
let recordedSampleRate; // The sample was recorded with this sampleRate

let samplingStartTime;

// save vars
let saves = [];

// Get progress bar element
const recSampleContainer = $("#recSampleContainer");
const recProgressBar = $("#recProgressBar");
const recProgressBarContainer = $("#recProgressBarContainer");
const recProgressBarLabel = $("#recProgressBarLabel");

// Get label elements
const recSampleLengthLabel = $("#recSampleLengthLabel");
const savSampleLengthLabel = $("#savSampleLengthLabel");

// Get sliders elements
const rtAmplificationSlider = $("#rtAmplificationSlider");
const rtAmplificationValue = $("#rtAmplificationValue");
rtAmplificationSlider.addEventListener("input", onRtAmplificationSliderChange);
rtAmplificationSlider.addEventListener("dblclick", onRtAmplificationSliderDblClick);
rtAmplificationValue.addEventListener("dblclick", onRtAmplificationSliderDblClick);

// Get inputs and selects elements
const sampleLengthInput = $("#sampleLengthInput");
sampleLengthInput.addEventListener("keyup", function(event){onSampleLengthInputKeyup(event)});

const saveNameInput = $("#saveNameInput");
saveNameInput.addEventListener("keyup", function(event){onSaveNameInputKeyup(event)});

const fileInput = $("#fileInput");
fileInput.addEventListener("change", function(event){onFileInputChange(event)});

const fileInputResultDiscardButton = $("#fileInputResultDiscardButton");
fileInputResultDiscardButton.addEventListener("click", onFileInputResultDiscardButtonClick);

const recSampleRateSelect = $("#recSampleRateSelect");
recSampleRateSelect.addEventListener("change", onRecSampleRateSelectChange);

const savSampleRateSelect = $("#savSampleRateSelect");
savSampleRateSelect.addEventListener("change", onSavSampleRateSelectChange);

// Get the tab bar and tab buttons elements
const tabBar = $("#tabBar");

let tabButtons = [];
tabButtons[0] = $("#rtTabButton");
tabButtons[1] = $("#recTabButton");
tabButtons[0].addEventListener("click", function(){onTabButtonClick(0)});
tabButtons[1].addEventListener("click", function(){onTabButtonClick(1)});

let tabs = [];
tabs[0] = $("#rtTab");
tabs[1] = $("#recTab");
tabs[2] = $("#savTab");

const sampleTabButton = $("#sampleTabButton");
const fileTabButton = $("#fileTabButton");
sampleTabButton.addEventListener("click", function(){onRecTabButtonClick(0)});
fileTabButton.addEventListener("click", function(){onRecTabButtonClick(1)});

const sampleTab = $("#sampleTab");
const fileTab = $("#fileTab");

// Get buttons elements
const pauseButton = $("#pauseButton");
pauseButton.addEventListener("click", onPauseButtonClick);

const rtSaveButton = $("#rtSaveButton");
rtSaveButton.addEventListener("click", onRtSaveButtonClick);

const sampleButton = $("#sampleButton");
sampleButton.addEventListener("click", onSampleButton);

let recPlayToggleButton = new ToggleButton($("#recPlayButton"),"<i class='fas fa-play'></i> Lire","<i class='fas fa-stop'></i> Stop",onRecPlayButtonClick,onRecStopButtonClick);
let savPlayToggleButton = new ToggleButton($("#savPlayButton"),"<i class='fas fa-play'></i> Lire","<i class='fas fa-stop'></i> Stop",onSavPlayButtonClick,onSavStopButtonClick);

const recSaveButton = $("#recSaveButton");
recSaveButton.addEventListener("click", onRecSaveButtonClick);

const validateSaveButton = $("#validateSaveButton");
validateSaveButton.addEventListener("click", onValidateSaveButtonClick);

const validateFileButton = $("#validateFileButton");
validateFileButton.addEventListener("click", onValidateFileButtonClick);

const fourierReplotButton = $("#fourierReplotButton");
fourierReplotButton.addEventListener("click", onFourierReplotButtonClick);

const downloadButton = $("#downloadButton");
downloadButton.addEventListener("click", ondownloadButtonClick);

const infoButton = $("#infoButton");
infoButton.addEventListener("click", onInfoButtonClick);
const closeInfoButton = $("#closeInfoButton");
closeInfoButton.addEventListener("click", onCloseInfoButtonClick);

const simpleModeButton = $("#simpleModeButton");
simpleModeButton.addEventListener("click", function(){onSelectModeButtonClick(0)});
const fullModeButton = $("#fullModeButton");
fullModeButton.addEventListener("click", function(){onSelectModeButtonClick(1)});

populateSampleRateSelect(recSampleRateSelect, 1, 16);

/*----------------------------------------------------------------------------------------------
-----------------------------------------GRAPH SETTINGS-----------------------------------------
----------------------------------------------------------------------------------------------*/

let rtWaveOptions = new HighchartOptions(null, "Temps (s)", "Amplitude", 0, 0.04, -32768, 32768, 0, undefined, false, false);
let rtFourierOptions = new HighchartOptions(null, "Fréquence (Hz)", "Amplitude", 0, 10000, 0, 32768, 0, undefined, false, false);

let recWaveOptions = new HighchartOptions(null, "Temps (s)", "Amplitude", 0, 0.05, -32768, 32768, 7, "xy");
let recFourierOptions = new HighchartOptions(null, "Fréquence (Hz)", "Amplitude", 0, 10000, 0, 32768, 2, "xy");

let savWaveOptions = new HighchartOptions(null, "Temps (s)", "Amplitude", 0, 0.05, -32768, 32768, 7, "xy");
let savFourierOptions = new HighchartOptions(null, "Fréquence (Hz)", "Amplitude", 0, 10000, 0, 32768, 2, "xy");
let savTemporalFourierOptions = {
	chart: {
		type: "heatmap",
		zoomType:"xy",
		spacingLeft: 0,
		spacingBottom: 0
	},
	title: {
    text: null
	},
	credits: {
		enabled: false
	},
	legend: {
		align: 'right',
		layout: 'vertical',
		margin: 0,
		verticalAlign: 'top',
		y: 25,
		symbolHeight: 280
	},
	yAxis: {
		title: {
      text: "Temps (s)"
    },
		min: 0,
		max: 2
	},
	xAxis: {
		title: {
      text: "Fréquence (Hz)"
		},
		minPadding: 0,
		maxPadding: 0,
		startOnTick: false,
		endOnTick: false,
		min: 0,
		max: 10000,
	},
	colorAxis: {
		minColor: "#e6ebf5",
		maxColor: "#003399",
		min: 0,
		max: 20000
		},
		tooltip: {
			formatter: function() {
				console.log(this.x);
				return "Fréquence: <b>" + Highcharts.numberFormat(this.x, 10) + "</b><br>" + "Temps: <b>" + Highcharts.numberFormat(this.y,1) + "</b>";
			}
		},
	series:[{colsize:10//span columns on 10 units
	}]
}

savWaveOptions.chart.events = {selection: function(event){onSavWaveGraphSelection(event)}};
savFourierOptions.chart.events = {selection: function(event){onSavFourierGraphSelection(event)}};
savTemporalFourierOptions.chart.events = {selection: function(event){onSavTemporalFourierGraphSelection(event)}};

/*----------------------------------------------------------------------------------------------
---------------------------------------Create the graphs ---------------------------------------
----------------------------------------------------------------------------------------------*/
let rtWaveChart = new Highcharts.chart('rtGraphContainer', rtWaveOptions);
let rtFourierChart = new Highcharts.chart('rtFourierContainer', rtFourierOptions);

let recWaveChart = new Highcharts.chart('recGraphContainer', recWaveOptions);
let recFourierChart = new Highcharts.chart('recFourierContainer', recFourierOptions);

let savWaveChart = new Highcharts.chart('savGraphContainer', savWaveOptions);
let savFourierChart = new Highcharts.chart('savFourierContainer', savFourierOptions);
let savTemporalFourierChart = new Highcharts.chart('savTemporalFourierContainer', savTemporalFourierOptions);

savWaveChart.xAxis[0].allowZoomOutside = true;
savWaveChart.yAxis[0].allowZoomOutside = true;
savFourierChart.xAxis[0].allowZoomOutside = true;
savFourierChart.yAxis[0].allowZoomOutside = true;
savTemporalFourierChart.xAxis[0].allowZoomOutside = true;
savTemporalFourierChart.yAxis[0].allowZoomOutside = true;

/*----------------------------------------------------------------------------------------------
-----------------------------------------DRAW FUNCTIONS-----------------------------------------
----------------------------------------------------------------------------------------------*/
function realtimeDraw() {
	if(paused == false){
	// sample
	rtWaveData = new LinearData(audio.getGraph(), 1 / baseSampleRate);

	// Compute the fourier
	if(simpleMode == false){
		rtFourierData = computeFourier(rtWaveData, baseSampleRate);
	} else{
		rtFourierData = null;
	}

	// Initial Draw
	if(rtInitialDraw && rtWaveData.data.length > 0){
		rtWaveChart.series[0].pointInterval = rtWaveData.step * 2;
		rtWaveChart.series[0].setData(arrayCopy(rtWaveData.getData(2, rtLength, true)));
		if(simpleMode == false){
			rtFourierChart.series[0].pointInterval = rtFourierData.step;
			rtFourierChart.series[0].setData(arrayCopy(rtFourierData.getData()));
		}
		rtInitialDraw = false;
	}

	// Update datas and redraw the serie (not the whole graph)
	rtWaveChart.series[0].setData(arrayCopy(rtWaveData.getData(2, rtLength, true)), false);
	rtWaveChart.series[0].redraw();
	if(simpleMode == false){
		rtFourierChart.series[0].setData(arrayCopy(rtFourierData.getData()), false);
		rtFourierChart.series[0].redraw();
	}
	};
}

function recordDraw() {
	// Reflow the charts to the div size
	recWaveChart.reflow();
	recFourierChart.reflow();
	
	// Update the progressBar
	if(recProgressBarContainer.style.display === "block"){
		
		let elapsedTime = Date.now() - samplingStartTime;
		recProgressBar.style.width = Math.min((elapsedTime) / (sampleLength * 10), 100) + '%';
		let remainingTime = new Date(Math.max(0, sampleLength - (Date.now() - samplingStartTime)));

		recProgressBarLabel.innerHTML = formatDate(Math.max(0,sampleLength * 1000 - (Date.now() - samplingStartTime)));
	}

	// sample
	if(audio.isDataAvailable() == true){
		// Hide the progress bar
		recProgressBarContainer.style.display = "none";
		recProgressBarLabel.style.display = "none";
		sampleButton.style.display = "block";

		recordGraphDraw(audio.getRecord(), recSampleRate);
	}
}

function recordGraphDraw(_data){
		// Discard old datas and create a new LinearData
		recWaveData = new LinearData(_data, 1 / baseSampleRate)
		// Display the save and playback buttons
		recSampleContainer.style.display = "block";
		// Display the sample length
		recSampleLengthLabel.innerHTML = formatDate(recWaveData.getDuration() * 1000);
		// Compute the dft
		if(simpleMode == false){
			recFourierData = computeFourier(recWaveData, recordedSampleRate);
		} else{
			recFourierData = null;
		}
		// Plot graphs
		recWaveChart.xAxis.max = recWaveData.getDuration();
		recWaveChart.series[0].pointInterval = recWaveData.step * (baseSampleRate / recordedSampleRate);
		recWaveChart.series[0].setData(arrayCopy(recWaveData.getData(baseSampleRate / recordedSampleRate)));

		if(simpleMode == false){
			recFourierChart.series[0].pointInterval = recFourierData.step;
			recFourierChart.series[0].setData(arrayCopy(recFourierData.getData()));
		}
}

function saveDraw() {
	// Reflow the charts to the div size
	savWaveChart.reflow();
	savFourierChart.reflow();
	savTemporalFourierChart.reflow();

	// Populate the sample rate 
	populateSampleRateSelect(savSampleRateSelect, saves[activeTab-2].recordedSampleRateLvl, 32);
	
	// Select the right option
	savSampleRateSelect.selectedIndex = Math.log2(saves[activeTab-2].displaySampleRateLvl) - Math.log2(saves[activeTab-2].recordedSampleRateLvl);

	// Display the sample length
	savSampleLengthLabel.innerHTML = formatDate(saves[activeTab-2].linearData.getDuration() * 1000);

	// Update the data & apply zoom
	savWaveChart.series[0].pointInterval = saves[activeTab-2].linearData.step * saves[activeTab-2].displaySampleRateLvl;
	savWaveChart.series[0].setData(arrayCopy(saves[activeTab-2].linearData.getData(saves[activeTab-2].displaySampleRateLvl)), false);
	savWaveChart.zoom({xAxis:[{min:saves[activeTab-2].range.xRange[0],max:saves[activeTab-2].range.xRange[1], axis:savWaveChart.xAxis[0]}], yAxis:[{min:saves[activeTab-2].range.yRange[0],max:saves[activeTab-2].range.yRange[1], axis:savWaveChart.yAxis[0]}]});

	// Display the right fourier type and update the datas
	if(saves[activeTab-2].fourierType == 0 && simpleMode == false){
		$("#savRegularFourierCard").style.display = "block";
		$("#savTemporalFourierCard").style.display = "none";
		savFourierChart.series[0].pointInterval = saves[activeTab-2].fLinearData.step;
		savFourierChart.series[0].setData(arrayCopy(saves[activeTab-2].fLinearData.getData()), false);
		savFourierChart.zoom({xAxis:[{min:saves[activeTab-2].fourierRange.xRange[0],max:saves[activeTab-2].fourierRange.xRange[1], axis:savFourierChart.xAxis[0]}], yAxis:[{min:saves[activeTab-2].fourierRange.yRange[0],max:saves[activeTab-2].fourierRange.yRange[1], axis:savFourierChart.yAxis[0]}]});
	}
	if(saves[activeTab-2].fourierType == 1 && simpleMode == false){
		$("#savRegularFourierCard").style.display = "none";
		$("#savTemporalFourierCard").style.display = "block";
		savTemporalFourierChart.series[0].setData(saves[activeTab-2].fTemporalData);
		savTemporalFourierChart.zoom({xAxis:[{min:saves[activeTab-2].fourierRange.xRange[0],max:saves[activeTab-2].fourierRange.xRange[1], axis:savTemporalFourierChart.xAxis[0]}], yAxis:[{min:saves[activeTab-2].fourierRange.yRange[0],max:saves[activeTab-2].fourierRange.yRange[1], axis:savTemporalFourierChart.yAxis[0]}]});
	}
}

function draw() {
	requestAnimationFrame(draw);

	// resume the audio context if it is suspended
	audio.resumeContext();

	switch(activeTab){
	case 0:
		realtimeDraw();
		break;
	case 1:
		recordDraw();
		break;
	}
};

/*----------------------------------------------------------------------------------------------
-------------------------------------DEEP COPY FUNCTION-----------------------------------------
----------------------------------------------------------------------------------------------*/
function arrayCopy(_array, _length = _array.length){
	let copy = [];
	for(let i = 0; i < _length; i++){
		copy[i] = _array[i];
	}
	return copy;
}

/*----------------------------------------------------------------------------------------------
---------------------------------------COMPUTE FOURIER------------------------------------------
----------------------------------------------------------------------------------------------*/
function computeFourier(_wave, _sampleRate, _range){
	let startIndex;
	let stopIndex;
	if(_range == undefined){
		startIndex = 0;
		stopIndex = _wave.data.length;
	}
	else{
		startIndex = Math.floor(_range[0] * _sampleRate);
		stopIndex = Math.floor(_range[1] * _sampleRate);
	}

	// Select the needed datas
	let fftInput = new LinearData(_wave.getData(baseSampleRate / _sampleRate).slice(startIndex, stopIndex));

	// limit dft to 10 kHz
	let maxIndex = fftInput.data.length / 2;
	if(_sampleRate / 2 > 10000){
		maxIndex = fftInput.data.length / _sampleRate * 10000 + 1;
	}
	// Plot the dft
	let result = new LinearData(new Float32Array(maxIndex));
	fourier.computeNormalizedFft(fftInput, result, _sampleRate, false);
	return result;

}

function computeTemporalFourier(_wave, _sampleRate, _range){
	let startIndex;
	let stopIndex;
	if(_range == undefined){
		startIndex = 0;
		stopIndex = _wave.data.length;
	}
	else{
		startIndex = Math.floor(_range[0] * baseSampleRate);
		stopIndex = Math.floor(_range[1] * baseSampleRate);
	}

	// Select the needed datas
	let data = new LinearData(_wave.getData().slice(startIndex, stopIndex), 1 / baseSampleRate);

	// Split the data in chunks and perform dft on them
	let chunks = []
	for(let i = 0; (i+1) < data.getDuration() / chunkLength; i++){
		chunks[i] = computeFourier(new LinearData(data.getData().slice(i * chunkLength * baseSampleRate, (i+1) * chunkLength * baseSampleRate)), _sampleRate);
	}
	return chunks;
}

/*----------------------------------------------------------------------------------------------
---------------------------------POPULATE SAMPLERATE SELECT-------------------------------------
----------------------------------------------------------------------------------------------*/
function populateSampleRateSelect(_select, _initLvl = 1, _l = 4){
	// Remove all previous options
	while (_select.firstChild) {
    _select.removeChild(_select.firstChild);
	}
	// Populate sampleRate selects based on baseSampleRate
	for (let i = _initLvl; i <= _l; i = i * 2) {
		let option = document.createElement("option");
		option.value = baseSampleRate / i;
		option.text = (baseSampleRate / i).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " Hz";
		_select.add(option);
	}
}

/*----------------------------------------------------------------------------------------------
------------------------------------POPULATE TABS FUNCTION--------------------------------------
----------------------------------------------------------------------------------------------*/
function populateTabs(){
	// Remove all tabs in the tabBar and the tabButtons array
	let tabElements = document.getElementsByClassName("savTab");
	while(tabElements.length > 0){
		tabElements[0].parentNode.removeChild(tabElements[0]);
	}
	tabButtons.length = 2;
	// Populate the tabBar
	for(let i = 0; i < saves.length; i++){
	// Add a tab button in the tabBar
	let newButton = document.createElement("span"); // span because we nest a button in it
	let firstHalf = document.createElement("span");
	let secondHalf = document.createElement("span");

	// Add the icon
	let icon = document.createElement("i");
	icon.className ="fas fa-bookmark";
	firstHalf.appendChild(icon);
	
	// Set the button's text
	let newText = document.createTextNode(" " + saves[i].name);
	firstHalf.appendChild(newText);

	// Set the delete button's icon
	let closeIcon = document.createElement("i");
	closeIcon.className ="fas fa-times";
	secondHalf.appendChild(closeIcon);
	
	newButton.className ="w3-bar-item savTab phy-tab w3-hover-none";
	firstHalf.className ="w3-button w3-hover-none phy-tab-alt w3-padding-small";
	secondHalf.className ="w3-button w3-hover-none phy-tab-close-button";

	newButton.style.padding = 0;

	newButton.appendChild(firstHalf);
	newButton.appendChild(secondHalf);
	tabBar.appendChild(newButton);

	// Set the callbacks
	tabButtons[i + 2] = newButton;
	firstHalf.addEventListener("click", function(){onTabButtonClick(i + 2)});
	secondHalf.addEventListener("click", function(){onTabCloseButtonClick(i)});
	}
}

/*----------------------------------------------------------------------------------------------
-----------------------------------AUDIO PLAYBACK FUNCTION--------------------------------------
----------------------------------------------------------------------------------------------*/
function audioPlayback(_data, _sr, _callback){
	// Prepare the datas if the samplerate is not default
		if(_sr != baseSampleRate){
			let factor = baseSampleRate / _sr; 
			let prepData = [];
			for(let i = 0; i < _data.length; i++){
				prepData[i * factor] = _data[i];
				for(let j = 1; j < factor; j++){
					prepData[i * factor + j] =  (_data[i + 1] - _data[i]) / factor * j + _data[i + 1];
				}
			}
		
		// Play the recorded sound
		audio.play(prepData);
	}
	else{
		// Play the recorded sound
		audio.play(_data);
	}

	// New source created everytime = reset event functions
	audio.playbackSource.onended = function(){_callback()};
}

/*----------------------------------------------------------------------------------------------
-------------------------------------HIHGCHART ZOOM EVENTS--------------------------------------
----------------------------------------------------------------------------------------------*/
function onSavWaveGraphSelection(event){
	if (event.xAxis != undefined){ // handmade selection
		saves[activeTab-2].range.xRange = [event.xAxis[0].min, event.xAxis[0].max];
		saves[activeTab-2].range.yRange = [event.yAxis[0].min, event.yAxis[0].max];
	} else{ // Reset zoom button
		saves[activeTab-2].range.xRange = [undefined, undefined];
		saves[activeTab-2].range.yRange = [undefined, undefined];
	}
}

function onSavFourierGraphSelection(event){
	if (event.xAxis != undefined){ // handmade selection
		saves[activeTab-2].fourierRange.xRange = [event.xAxis[0].min, event.xAxis[0].max];
		saves[activeTab-2].fourierRange.yRange = [event.yAxis[0].min, event.yAxis[0].max];
	} else{ // Reset zoom button
		saves[activeTab-2].fourierRange.xRange = [undefined, undefined];
		saves[activeTab-2].fourierRange.yRange = [undefined, undefined];
	}
}

function onSavTemporalFourierGraphSelection(event){
	if (event.xAxis != undefined){ // handmade selection
		saves[activeTab-2].fourierRange.xRange = [event.xAxis[0].min, event.xAxis[0].max];
		saves[activeTab-2].fourierRange.yRange = [event.yAxis[0].min, event.yAxis[0].max];
	} else{ // Reset zoom button
		saves[activeTab-2].fourierRange.xRange = [undefined, undefined];
		saves[activeTab-2].fourierRange.yRange = [undefined, undefined];
	}
}

/*----------------------------------------------------------------------------------------------
---------------------------------------------EVENTS---------------------------------------------
----------------------------------------------------------------------------------------------*/
function onPauseButtonClick() {
	if(paused == true){
		paused = false;
		pauseButton.classList.remove("w3-red");
		pauseButton.classList.add("w3-white");
		// Hide the record button
		rtSaveButton.style.display = "none";
	}
	else{
		paused = true;
		pauseButton.classList.remove("w3-white");
		pauseButton.classList.add("w3-red");
		// Show the record button
		rtSaveButton.style.display = "block";
	}
}

function onRtSaveButtonClick() {
	// Display save modal
	$("#saveModal").style.display="block";

	// Focus the input
	saveNameInput.focus();
}

function onRecPlayButtonClick() {
	audioPlayback(recWaveData.getData(baseSampleRate / recordedSampleRate), recordedSampleRate, onRecPlaybackEnded);
}

function onRecStopButtonClick() {
	audio.stop();
}

function onRecPlaybackEnded(){
	recPlayToggleButton.setState(true);
}

function onSavPlayButtonClick() {
	// Prepare the datas if the samplerate is not default
	let sr = baseSampleRate / saves[activeTab-2].displaySampleRateLvl;
	audioPlayback(saves[activeTab-2].linearData.getData(saves[activeTab-2].displaySampleRateLvl), sr, onSavPlaybackEnded);
}

function onSavStopButtonClick() {
	audio.stop();
}

function onSavPlaybackEnded(){
	savPlayToggleButton.setState(true);
}

function onRecSaveButtonClick() {
	// Display save modal
	$("#saveModal").style.display="block";

	// Focus the input
	saveNameInput.focus();
}

function onValidateSaveButtonClick() {
	// Get the save name
	let text;
	if(saveNameInput.value == ""){
		text = "Enreg";
	}
	else{
		text = saveNameInput.value;
	}

	if(activeTab == 0){
		saves.push({
			name: text,
			linearData: rtWaveData,
			fLinearData: rtFourierData,
			fTemporalData: [],
			recordedSampleRateLvl: 1,
			displaySampleRateLvl: 1,
			range: {xRange: [undefined, undefined], yRange: [undefined, undefined]},
			fourierRange: {xRange: [undefined, undefined], yRange: [undefined, undefined]},
			fourierType: 0
		});
	}
	else{
		saves.push({
			name: text,
			linearData: recWaveData,
			fLinearData: recFourierData,
			fTemporalData: [],
			recordedSampleRateLvl: baseSampleRate / recordedSampleRate,
			displaySampleRateLvl: baseSampleRate / recordedSampleRate,
			range: {xRange: [undefined, undefined], yRange: [undefined, undefined]},
			fourierRange: {xRange: [undefined, undefined], yRange: [undefined, undefined]},
			fourierType: 0
		});
	}
	// Redraw tabs
	populateTabs();

	// Empty the input and hide the modal card
	saveNameInput.value = "";
	$("#saveModal").style.display = "none";
}

function onValidateFileButtonClick() {
	$("#fileModal").style.display = "none";
}

function onSelectModeButtonClick(_id){
	$("#introModal").style.display = "none";
	if(_id == 0){
		simpleMode = true;

		// Hide fourier graph cards
		$("#rtFourierContainer").parentNode.style.display = "none";
		$("#recFourierContainer").parentNode.style.display = "none";
		$("#savFourierContainer").parentNode.style.display = "none";

		// Hide fourier menu card
		$("#fourierCard").style.display = "none";

		// Resize wave charts to full height
		$("#rtGraphContainer").style.height = "calc(100vh - 124px)";
		$("#recGraphContainer").style.height = "calc(100vh - 124px)";
		$("#savGraphContainer").style.height = "calc(100vh - 124px)";
	} else{
		simpleMode = false;
	}
	// Reflow charts
	rtWaveChart.reflow();

	paused = false;
}


function onSaveNameInputKeyup(event){
	// Cancel the default action, if needed
	event.preventDefault();
	// Number 13 is the "Enter" key on the keyboard
	if (event.keyCode === 13) {
	// Click on validate
	onValidateSaveButtonClick();
  }
}

function onSampleLengthInputKeyup(event){
	// Cancel the default action, if needed
	event.preventDefault();
	// Number 13 is the "Enter" key on the keyboard
	if (event.keyCode === 13) {
	// "Unfocus" the input
	sampleLengthInput.blur();
  }
}

function onFourierReplotButtonClick() {
	// Save the ranges
	saves[activeTab-2].fourierPlottingRange = [savWaveChart.xAxis[0].min,savWaveChart.xAxis[0].max];

	if($("#fourierTypeChoice0").checked){
		// display the regular dft
		$("#savRegularFourierCard").style.display = "block";
		$("#savTemporalFourierCard").style.display = "none";

		// Compute the dft
		saves[activeTab-2].fLinearData = computeFourier(saves[activeTab-2].linearData, baseSampleRate / saves[activeTab-2].displaySampleRateLvl, saves[activeTab-2].fourierPlottingRange);

		// Update and redraw
		savFourierChart.series[0].pointInterval = saves[activeTab-2].fLinearData.step;
		savFourierChart.series[0].setData(arrayCopy(saves[activeTab-2].fLinearData.getData()));
		if(saves[activeTab-2].fourierType != 0){
			// User changed fourier type => reset zoom
			savFourierChart.zoom({xAxis:[{min:undefined,max:undefined, axis:savFourierChart.xAxis[0]}], yAxis:[{min:undefined,max:undefined, axis:savFourierChart.yAxis[0]}]});
		}
		// Log fourier type displayed
		saves[activeTab-2].fourierType = 0;
	}
	else{
		// check data size and return if too short
		if(saves[activeTab-2].fourierPlottingRange[1] - saves[activeTab-2].fourierPlottingRange[0] < 0.5){
			alert("La durée doit être supérieure à 0,5s pour réaliser une analyse spectrale temporelle.");
			return;
		}
		// display the temporal dft
		$("#savRegularFourierCard").style.display = "none";
		$("#savTemporalFourierCard").style.display = "block";

		let chunks = computeTemporalFourier(saves[activeTab-2].linearData, baseSampleRate / saves[activeTab-2].displaySampleRateLvl, saves[activeTab-2].fourierPlottingRange);
		// Format data
		let highestAmplitude = 0;
		saves[activeTab-2].fTemporalData = [];
		for(let i = 0; i < chunks.length; i++){
			for(let j = 0; j < chunks[i].data.length; j++){
				saves[activeTab-2].fTemporalData[i * chunks[0].data.length + j] = [j * chunks[0].step, i * chunkLength, chunks[i].data[j]];
				if(chunks[i].data[j] > highestAmplitude){ // check for the highest amplitude
					highestAmplitude = chunks[i].data[j];
				}
			}
		}
		// Update boundaries
		savTemporalFourierChart.update({
			yAxis:{max:chunks.length * chunkLength},
			colorAxis:{max:highestAmplitude}
		});

		// Set the new datas and draw
		console.log(saves[activeTab-2].fTemporalData);
		savTemporalFourierChart.series[0].setData(saves[activeTab-2].fTemporalData);
		if(saves[activeTab-2].fourierType != 1){
			// User changed fourier type => reset zoom
			savTemporalFourierChart.zoom({xAxis:[{min:undefined,max:undefined, axis:savTemporalFourierChart.xAxis[0]}], yAxis:[{min:undefined,max:undefined, axis:savTemporalFourierChart.yAxis[0]}]});
		}
		// Log fourier type displayed
		saves[activeTab-2].fourierType = 1;
	}
}

function ondownloadButtonClick() {
	let sr = baseSampleRate / saves[activeTab-2].displaySampleRateLvl;
	let file = audio.generateWavFile(saves[activeTab-2].linearData.getData(saves[activeTab-2].displaySampleRateLvl), sr);
	phyDownload(file, saves[activeTab-2].name);
}

function onSampleButton() {
	// SampleLength value verifications
	if(sampleLengthInput.value === ""){
		alert("La durée d'enregistrement n'est pas un nombre valide.");
		return;
	}
	if(sampleLengthInput.value < 0.01){
		alert("La durée d'enregistrement minimale est de 0,01 s.");
		return;
	}
	if(sampleLengthInput.value > 30){
		alert("La durée d'enregistrement maximale est de 30 s.");
		return;
	}
	// Get the sampleLength
	sampleLength = parseFloat(sampleLengthInput.value);

	// Record new datas
	audio.startRecording(sampleLength);

	// Save the sampleRate used
	recordedSampleRate = recSampleRate;

	// Hide the playback controls
	recSampleContainer.style.display = "none";

	// Save the sampling start time
	samplingStartTime = Date.now();

	// Display the progress bar
	recProgressBarContainer.style.display = "block";
	sampleButton.style.display = "none";

	// Display the remaining time if sampleLength > 1 s
	if(sampleLength >= 1){
		recProgressBarLabel.style.display = "block";
	}
}

function onRecSampleRateSelectChange() {
	recSampleRate = recSampleRateSelect.value;
}

function onSavSampleRateSelectChange() {
	saves[activeTab-2].displaySampleRateLvl = baseSampleRate / savSampleRateSelect.value;
	saveDraw();
}

function onTabButtonClick(_id) {
	// Store the activeTab id
	activeTab = _id;

	// UnActivate all buttons
	for(let i = 0; i < tabButtons.length; i++){
		tabButtons[i].classList.remove("phy-tab-active");
	}
	// Activate the clicked button
	tabButtons[_id].classList.add("phy-tab-active");

	// Hide all tabs
	for(let i = 0; i < tabs.length; i++){
		tabs[i].style.display = "none";
	}

	// Show the active tab
	if(_id > 1){
		tabs[2].style.display = "block";

		// Draw the active sav tab
		saveDraw();
	}
	else{
		tabs[_id].style.display = "block";
	}
}

function onRecTabButtonClick(_id) {
	sampleTabButton.classList.remove("phy-tab-active");
	fileTabButton.classList.remove("phy-tab-active");
	if(_id == 0){
		sampleTab.style.display = "block";
		fileTab.style.display = "none";

		sampleTabButton.classList.add("phy-tab-active");
	}
	else{
		sampleTab.style.display = "none";
		fileTab.style.display = "block";

		fileTabButton.classList.add("phy-tab-active");
	}
}

function onTabCloseButtonClick(_id) {
	tabButtons[_id+2].classList.add("phy-fadeout");
	setTimeout(function(){
		// Delete tab datas
		saves.splice(_id,1);
		// Populate tabs
		populateTabs();
		// Active the active tab (duh)
		if(activeTab > _id + 1){
			activeTab = activeTab - 1;
			onTabButtonClick(activeTab);
		}
		else{
			onTabButtonClick(activeTab);
		}
	}, 250);
}

function onRtAmplificationSliderChange() {
	audio.setGain(rtAmplificationSlider.value);
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

function onRtAmplificationSliderDblClick() {
	audio.setGain(1); // Default
	rtAmplificationSlider.value = 1;
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

function onInfoButtonClick() {
	$("#infoModal").style.display="block";
}

function onCloseInfoButtonClick(){
	$("#infoModal").style.display="none";
}
/*----------------------------------------------------------------------------------------------
-------------------------------------FILE LOADING FUNCTIONS-------------------------------------
----------------------------------------------------------------------------------------------*/
function onFileInputChange(event){
	// Read the file
	fileReader.readAsArrayBuffer(fileInput.files[0]);
	// Hide the playback controls
	recSampleContainer.style.display = "none";
	// Hide the fileInput button
	$("#inputFileButton").style.display="none";
	// Display the decoding label
	$("#inputFileDecodingLabel").style.display="block";
}

function onFileInputResultDiscardButtonClick(event){
	fileInput.value = "";
	$("#inputFileButton").style.display="block";
	$("#fileInputResult").style.display="none";
}

function onFileReaderLoadEnd(){
	// Decode the audio in the file
	audio.decode(fileReader.result, onAudioDecodeEnd);
}

function onAudioDecodeEnd(_rawData){
	$("#inputFileDecodingLabel").style.display="none";
	$("#fileInputResult").style.display="flex";

	let length = _rawData.duration * baseSampleRate;
	if(_rawData.duration > 20){
		// Display save modal
		$("#fileModal").style.display="block";
		length = baseSampleRate * 20;
	}
	// Save the sampleRate used DUMMY
	recordedSampleRate = baseSampleRate;

	// Draw the datas
	recordGraphDraw(convertFloat32ToInt16(_rawData.getChannelData(0), length), baseSampleRate);
}

/*----------------------------------------------------------------------------------------------
-----------------------------------------WINDOWS.ONLOAD-----------------------------------------
----------------------------------------------------------------------------------------------*/
window.onload = function() {
	// Init the file inputs logic
	initFileInputs();

	// Init the rt gain slider
	onRtAmplificationSliderChange()

	// Display the intro modal
	$("#introModal").style.display="block";

	// Activate a tab
	onTabButtonClick(0);
	onRecTabButtonClick(0);

	draw();
};

// TODO LIST:
// - plot lines to show playback

</script>
</body>
</html> 