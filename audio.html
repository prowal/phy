<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 
	MIT License

	La Belle Physique : Analyseur audio

	Copyright (c) 2018 Gaétan Walter

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->

	<title>Analyseur audio</title>

	<link rel="stylesheet" href="lib/w3.css">
	<link rel="stylesheet" href="lib/w3-theme-teal.css"> 
	<link rel="stylesheet" href="lib/w3-theme-indigo.css"> 

	<link rel="stylesheet" href="lib/fontawesome/css/all.min.css">

	<link rel="stylesheet" href="lib/phy.css">

	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

	<script src="lib/Chart.min.js"></script>

	<script src="lib/phy.js"></script>

	<script src="lib/audio.js"></script>

	<script src="lib/fft.js"></script>

	<style>

	</style>

</head>
<body class="w3-light-grey">
	<!-- Header bar -->
	<div class="w3-card-4 w3-theme">
		<div class="w3-bar w3-center">
			<span class="w3-bar-item w3-display-topmiddle w3-xlarge"><b>Analyseur audio</b></span>
			<button class="w3-bar-item w3-button w3-right w3-xlarge" id="infoButton"><b><i class="fas fa-info-circle fa-lg"></i></b></button>
			<a href="index.html" class="w3-bar-item w3-button w3-left w3-xlarge" id="homeButton"><b><i class="fas fa-home fa-lg"></i></b></a>
		</div>
		<div id="tabBar" class="w3-bar">
			<button id ="rtTabButton" class="w3-bar-item w3-button w3-hover-none phy-tab">TEMPS REEL</button>
			<button id ="recTabButton" class="w3-bar-item w3-button w3-hover-none phy-tab">ENREGISTRER</button>
			<span class="w3-bar-item w3-opacity"><i class="fas fa-minus fa-rotate-90"></i></span>
			<button class="w3-bar-item w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Enreg. 1</button>
			<button class="w3-bar-item w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Enreg. 1</button>
			<button class="w3-bar-item w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Enreg. 1</button>
			<button class="w3-bar-item w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Enreg. 1</button>
			<button class="w3-bar-item w3-button w3-hover-none phy-tab"><i class="fas fa-file-audio"></i> Enreg. 1</button>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!-------------------------------REALTIME TAB------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="rtTab" class="w3-row">
		<div class="w3-col w3-right" style="width: 320px">
			<!-- First right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Paramètres</h3>
				</header>
				<div class="w3-container w3-white">
					<p class="w3-opacity"><b>Amplification :</b></p>
					<input class="range-slider_range" id="rtAmplificationSlider" type="range" value="10" min="0" max="20">
					<span class="range-slider_value" id="rtAmplificationValue">x 1</span>
				</div>
			</div>
			<!-- Second right card -->
			<div class="w3-card-4 w3-margin w3-white">
				<button class="w3-button w3-block w3-hover-red" id="pauseButton"><h3 style="margin:0"><i class="fas fa-pause"></i> Pause</h3></button>
				<button class="w3-button w3-block" id="rtSaveButton" style="display:none"><h3 style="margin:0"><i class="fas fa-save"></i> Sauvegarder</h3></button>
			</div>
		</div>
		<!-- Graph card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div class="w3-container w3-margin" style="height: 40vh; padding:0">
				<canvas class="rtWaveCanvas"></canvas>
			</div>
		</div>
		<!-- Fourier card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div class="w3-container w3-margin" style="height: 35vh; padding:0">
				<canvas class="rtFourierCanvas"></canvas>
			</div>
		</div>
	</div>
	<!-------------------------------------------------------------------------->
	<!--------------------------------RECORD TAB-------------------------------->
	<!-------------------------------------------------------------------------->
	<div id="recTab" class="w3-row" style="display:none">
		<div class="w3-col w3-right" style="width: 320px">
			<!-- First right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Acquisition</h3>
				</header>
				<div class="w3-container w3-white">
					<label class="w3-opacity phy-menu-label"><b>Amplification</b></label>
					<input class="range-slider_range" id="amplificationSlider" type="range" value="10" min="0" max="20">
					<span class="range-slider_value phy-no-bmargin" id="amplificationValue">10</span>
					<label class="w3-opacity phy-menu-label"><b>Durée d'acquisition</b></label>
					<input type="number" class="w3-input" id="sampleLengthInput" value="0.05" step="0.01" min="0.01" max="20">
					<label class="w3-opacity phy-menu-label"><b>Fréquence d'échantillonage</b></label>
					<select class="w3-select" name="option">
						<option value="1">48 000 Hz</option>
						<option value="2">24 000 Hz</option>
						<option value="3">12 000 Hz</option>
					</select> 
					<button class="w3-button w3-block w3-theme w3-hover-theme2" id="sampleButton" style="margin-top: 25px"><h3 style="margin:0"><i class="fas fa-microphone"></i> Acquisition</h3></button>
					<button class="w3-button w3-block" id="recSaveButton" style="margin-bottom: 15px;"><h3 style="margin:0"><i class="fas fa-save"></i> Sauvegarder</h3></button>
				</div>
			</div>
		</div>
		<!-- Graph card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div id="recGraphContainer"class="w3-container w3-margin" style="height: 40vh; padding:0">
			</div>
		</div>
		<!-- Fourier card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div id="recFourierContainer" class="w3-container w3-margin" style="height: 35vh; padding:0">
			</div>
		</div>		
	</div>

	<!-- Modal card -->
	<div id="modal" class="w3-modal">
    <div class="w3-modal-content w3-animate-top w3-card-4">
      <header class="w3-container w3-theme2"> 
        <span onclick="document.getElementById('modal').style.display='none'" class="w3-button w3-display-topright"><i class="fas fa-times"></i></span>
        <h2>À propos</h2>
      </header>
      <div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-info-circle fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Application permettant de générer des spectres RMN (simplistes) suffisamment lisibles pour être intégrés dans des activités, exercices, DS...</p>
					<p>Le site <a href="http://www.nmrdb.org/new_predictor">nmrdb</a> permet d'obtenir le spectre qui vous interesse juste en tracant la molécule.</p>
				</div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fab fa-firefox fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Les applications utilisent des technologies modernes pour fonctionner (HTLM5, CSS et JS). Il est indispensable d'utiliser un navigateur internet récent pour les faire fonctionner. Les applications ont été testés sur Mozilla Firefox et Google Chrome.</p></div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-envelope fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>pro.wal@protonmail.com</p></div>
			</div>
			<div class="w3-light-grey w3-section">
				<button onclick="accordion('licenceAccordion')" class="w3-button w3-block">
					<div class="w3-container w3-cell"><p><i class="fas fa-copyright fa-2x"></i></p></div>
					<div class="w3-container w3-cell"><p>MIT Licence</p></div>
				</button>
				<div id="licenceAccordion" class="w3-hide w3-container">
					<p><script src="lib/licence.js"></script></p>
				</div>
			</div>
    </div>
  </div>

<script>
const $ = document.querySelector.bind(document);

let p1 = 0;
let p2 = 0;
let p3 = 0;

// Declare vars
let rtWaveData = [];
let rtFourierData = [];

let rtWaveChart;
let rtFourierChart;

let recWaveData = [{
  x: [1, 2, 3, 4],
  y: [10, 15, 13, 17],
  mode: "line",
  name: "TODO",
	line: {
    color: 'rgb(219, 64, 82)',
    width: 3
  }
}];
let recFourierData = [{
  x: [1, 2, 3, 4],
  y: [10, 15, 13, 17],
  mode: "line",
  name: "TODO",
	line: {
    color: 'rgb(219, 64, 82)',
    width: 3
  }
}];

let recWaveChart;
let recFourierChart;

let stabilization = true;

let bufferSize = 4096;
let echFrequency = 48000; // TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO (may vary!)

let activeTab;

let paused = false;

// Create the fourier object
var fourier = new FFTNayuki(bufferSize);

// Create a PhyAudio object
let audio = new PhyAudio(bufferSize);

// Get canvas contexts (rt)
const rtWaveCanvasCtx = $("canvas.rtWaveCanvas").getContext("2d");
const rtFourierCanvasCtx = $("canvas.rtFourierCanvas").getContext("2d");

// Get div elements (rec)
//const rtWaveCanvasCtx = $("canvas.rtWaveCanvas").getContext("2d");
//const rtFourierCanvasCtx = $("canvas.rtFourierCanvas").getContext("2d");

// Get sliders elements
const rtAmplificationSlider = $("#rtAmplificationSlider");
const rtAmplificationValue = $("#rtAmplificationValue");
rtAmplificationSlider.addEventListener("input", onRtAmplificationSliderChange);
rtAmplificationSlider.addEventListener("dblclick", onRtAmplificationSliderDblClick);
rtAmplificationValue.addEventListener("dblclick", onRtAmplificationSliderDblClick);

// Get the tab bar and tab buttons elements
const tabBar = $("#tabBar");

let tabButtons = [];
tabButtons[0] = $("#rtTabButton");
tabButtons[1] = $("#recTabButton");
tabButtons[0].addEventListener("click", function(){onTabButtonClick(0)});
tabButtons[1].addEventListener("click", function(){onTabButtonClick(1)});

let tabs = [];
tabs[0] = $("#rtTab");
tabs[1] = $("#recTab");

// Get buttons elements
const pauseButton = $("#pauseButton");
pauseButton.addEventListener("click", onPauseButtonClick);

const rtSaveButton = $("#rtSaveButton");
rtSaveButton.addEventListener("click", onRtSaveButtonClick);



/*----------------------------------------------------------------------------------------------
-----------------------------------------GRAPH SETTINGS-----------------------------------------
----------------------------------------------------------------------------------------------*/

let rtGraphConfig = {
	type: "line",
	data: {
		datasets: [{
			label: "TODO",
			borderColor: phyColors.pink,
			// Hides the points...
			radius: 0,
			fill: false
		}]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false,
		},
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Temps (s)"
				},
				ticks: {
					min: 0,
					max: 0.05,
					//autoSkip: true,
					//maxTicksLimit: 10,
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: "Amplitude"
				},
				ticks: {
					suggestedMin: -1,
					suggestedMax: 1,
				}
			}]
		}
	}
};

let rtFourierConfig = {
	type: "line",
	data: {
		datasets: [{
			label: "TODO",
			borderColor: phyColors.pink,
			// Hides the points...
			radius: 0,
			fill: false
		}]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false,
		},
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Fréquence (Hz)"
				},
				ticks: {
					min: 0,
					max: 10000,
					//autoSkip: true,
					//maxTicksLimit: 10,
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: "Amplitude"
				},
				ticks: {
					suggestedMin: 0,
					suggestedMax: 1,
				}
			}]
		}
	}
};

let recGraphConfig = {
	autosize: true,
	responsive: true,
  xaxis: {
    title: "Temps (s)",
		range: [0, 0.05]
  },
  yaxis: {
    title: "Amplitude",
		range: [-1, 1]
  },
	margin: {
    l: 40,
    r: 20,
    b: 35,
    t: 30,
    pad: 2
  }
};

let recFourierConfig = {
	autosize: true,
	responsive: true,
  xaxis: {
    title: "Fréquence (Hz)",
		range: [0, 10000]
  },
  yaxis: {
    title: "Amplitude",
		range: [0, 1]
  },
	margin: {
    l: 40,
    r: 20,
    b: 35,
    t: 30,
    pad: 2
  }
};

/*----------------------------------------------------------------------------------------------
-----------------------------------------DRAW FUNCTIONS-----------------------------------------
----------------------------------------------------------------------------------------------*/
function realtimeDraw() {
	if(paused == false){
	// sample
	let graphData = audio.getGraph();

	// Set the new datas
	for(let i = 0; i < bufferSize; i++){
		rtWaveData[i] = {x: i / echFrequency, y: graphData[i] / 128.0 - 1};
	}

	// Compute the fourier
	let fourierData = fourier.computeNormalizedFft(rtWaveData, echFrequency, false);

	if(stabilization == true){
		stabilize(rtWaveData);
	}

	// Trim unnecessary data
	rtWaveData.splice(0.05 * echFrequency);

	// Set the new fourier datas
	for(let i = 0; i < bufferSize / echFrequency * 10000; i++){
		rtFourierData[i] = {x: fourierData[i].x, y: fourierData[i].y * 2 /*Arbitrary*/};
	}

	var t0 = performance.now();
	
	rtWaveChart.data.datasets[0].data = rtWaveData;
	rtWaveChart.update();
	var t1 = performance.now();
	p1 += (t1 - t0);
	p3 += 1;
	//console.log("update1: " + p1/p3 + " milliseconds.");
	t0 = performance.now();
	rtFourierChart.data.datasets[0].data = rtFourierData;
	rtFourierChart.update();
	t1 = performance.now();
	p2 += (t1 - t0);
	//console.log("update2: " + p2/p3 + " milliseconds.");
	};
}

function recordDraw() {
	Plotly.react("recGraphContainer", recWaveData, recGraphConfig);
	Plotly.react("recFourierContainer", recFourierData, recFourierConfig);
}

function draw() {
	requestAnimationFrame(draw);

	if(activeTab == 0){
		realtimeDraw();
	}
	else{
		recordDraw();
	}
};

/*----------------------------------------------------------------------------------------------
-------------------------------------------FUNCTION---------------------------------------------
----------------------------------------------------------------------------------------------*/

function stabilize(_data){
	let maximum = 0;
	let maximumIndex = 0;
	for(let i = 0; i < bufferSize / 10; i++){
		if(_data[i].y > maximum){
			maximum = _data[i].y;
			maximumIndex = i;
		}
	}

	for(let i = 0; i < bufferSize - maximumIndex; i++){
		_data[i + maximumIndex].x = i / echFrequency;
	}

	_data.splice(0,maximumIndex);
}

/*----------------------------------------------------------------------------------------------
---------------------------------------------EVENTS---------------------------------------------
----------------------------------------------------------------------------------------------*/
function onPauseButtonClick() {
	if(paused == true){
		paused = false;
		pauseButton.classList.remove("w3-red");
		pauseButton.classList.add("w3-white");
		// Hide the record button
		rtSaveButton.style.display = "none";
	}
	else{
		paused = true;
		pauseButton.classList.remove("w3-white");
		pauseButton.classList.add("w3-red");
		// Show the record button
		rtSaveButton.style.display = "block";
	}
}

function onRtSaveButtonClick() {
	// Click feedback animation
	rtSaveButton.classList.remove("w3-animate-opacity");
	void rtSaveButton.offsetWidth; // Provoke a reflow to allow a new animation
	rtSaveButton.classList.add("w3-animate-opacity");
	
	// Add a tab button in the tabBar
	let newButton = document.createElement("button");

	// Add the icon
	let audioFileIcon = document.createElement("i");
	audioFileIcon.className ="fas fa-file-audio" ;
	newButton.appendChild(audioFileIcon);
	
	// Set the button's text
	let newText = document.createTextNode(" Enreg");
	newButton.appendChild(newText);

	newButton.className ="w3-bar-item w3-button w3-hover-none phy-tab" ;
	tabBar.appendChild(newButton);
	}

function onTabButtonClick(_id) {
	// UnActivate all buttons
	for(let i = 0; i < tabButtons.length; i++){
		tabButtons[i].classList.remove("phy-tab-active");
	}
	// Activate the clicked button
	tabButtons[_id].classList.add("phy-tab-active");

	// Store the activeTab id
	activeTab = _id;

	// Hide all tabs
	for(let i = 0; i < tabs.length; i++){
		tabs[i].style.display = "none";
	}

	// Show the active tab
	tabs[_id].style.display = "block";
}

function onRtAmplificationSliderChange() {
	audio.setGain(rtAmplificationSlider.value / 10); // /10 to have integer values in the slider
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

function onRtAmplificationSliderDblClick() {
	audio.setGain(1); // Default
	rtAmplificationSlider.value = 10;
	rtAmplificationValue.innerHTML = "x " + audio.gain;
}

window.onload = function() {
	// Create the rt graph and link the datas
	rtWaveChart = new Chart(rtWaveCanvasCtx, rtGraphConfig);
	rtFourierChart = new Chart(rtFourierCanvasCtx, rtFourierConfig);

	// Init the rt gain slider
	onRtAmplificationSliderChange()

	// Create the rec graph and link the datas
	Plotly.react("recGraphContainer", recWaveData, recGraphConfig, {displaylogo: false, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});
	Plotly.react("recFourierContainer", recFourierData, recFourierConfig, {displaylogo: false, modeBarButtonsToRemove: ["toImage","sendDataToCloud"]});

	//window.onresize();

	// Activate a tab
	onTabButtonClick(0);

	draw();
};



</script>
</body>
</html> 