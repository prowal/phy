<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<!-- 
	MIT License

	La Belle Physique : Electrocardiogrammes

	Copyright (c) 2018 Gaétan Walter

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->

	<title>Electrocardiogrammes</title>

	<link rel="icon" href="img/ecg.ico" />

	<link rel="stylesheet" href="lib/w3.css"> 
	<link rel="stylesheet" href="lib/w3-theme-teal.css"> 
	<link rel="stylesheet" href="lib/w3-theme-indigo.css"> 

	<link rel="stylesheet" href="lib/fontawesome/css/all.min.css">

	<link rel="stylesheet" href="lib/phy.css"> 

	<script src="lib/Chart.min.js"></script>

	<script src="lib/ecg.js"></script>

	<script src="lib/phy.js"></script>

</head>
<body class="w3-light-grey">
	<!-- Header bar -->
	<div class="header w3-theme">
		<div class="w3-bar w3-card-4 w3-center">
			<span class="w3-bar-item w3-display-topmiddle w3-xlarge"><b>Electrocardiogrammes</b></span>
			<button class="w3-bar-item w3-button w3-right w3-xlarge" id="infoButton"><b><i class="fas fa-info-circle fa-lg"></i></b></button>
			<a href="index.html" class="w3-bar-item w3-button w3-left w3-xlarge" id="homeButton"><b><i class="fas fa-home fa-lg"></i></b></a>
		</div> 
	</div>

	<div class="w3-row">
		<div class="w3-col w3-right" style="width: 285px">
			<!-- First right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Choix du sportif</h3>
				</header>
				<div class="w3-container" style="padding: 0px">
					<button class="w3-button w3-block w3-hover-theme2" id="sportButton1"><i class="fas fa-basketball-ball fa-lg"></i> Basketeur</button>
					<button class="w3-button w3-block w3-hover-theme2" id="sportButton2"><i class="fas fa-futbol fa-lg"></i> Footballer</button>
					<button class="w3-button w3-block w3-hover-theme2" id="sportButton3"><i class="fas fa-bicycle fa-lg"></i> Cycliste</button>
					<button class="w3-button w3-block w3-hover-theme2" id="sportButton4"><i class="fas fa-swimmer fa-lg"></i> Nageur</button>
					<button class="w3-button w3-block w3-hover-theme2" id="sportButton5"><i class="fas fa-walking fa-lg"></i> Sprinteur</button>
				</div>
			</div>
			<!-- Second right card -->
			<div class="w3-card-4 w3-margin">
				<header class="w3-container w3-theme">
					<h3>Etat du sportif</h3>
				</header>
				<div class="w3-container" style="padding: 0px">
					<button class="w3-button w3-block w3-hover-theme2" id="stateButton1">Au repos</button>
					<button class="w3-button w3-block w3-hover-theme2" id="stateButton2">Après l'effort</button>
					<button class="w3-button w3-block w3-hover-theme2" id="stateButton3">Après récupération</button>
				</div>
			</div>
			<!-- Third right card -->
			<div class="w3-card-4 w3-margin w3-white">
					<button class="w3-button w3-block w3-hover-red" id="pauseButton"><h3 style="margin:0"><i class="fas fa-pause"></i> Pause</h3></button>
			</div>
		</div>
		<!-- Canvas card -->
		<div class="w3-card-4 w3-rest w3-margin w3-white">
			<div class="w3-container w3-margin" style="height: calc(100vh - 120px)">
				<canvas class="canvas"></canvas>
			</div>
		</div>
	</div>

	<!-- Modal card -->
	<div id="modal" class="w3-modal">
    <div class="w3-modal-content w3-animate-top w3-card-4">
      <header class="w3-container w3-theme2"> 
        <span onclick="document.getElementById('modal').style.display='none'" class="w3-button w3-display-topright"><i class="fas fa-times"></i></span>
        <h2>À propos</h2>
      </header>
      <div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-info-circle fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Application permettant de visualiser les électrocardiogrammes de 5 sportifs différents, au repos, après l’effort (1 minute de flexions) et après une minute de récupération.</p>
					<p>Ces électrocardiogrammes permettent de mesurer l’adaptation à l’effort de ces sportifs.</p>
					<p>Deux des sportifs ont une maladie cardiaque visible à l’électrocardiogramme.</p>
				</div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fab fa-firefox fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>Les applications utilisent des technologies modernes pour fonctionner (HTLM5, CSS et JS). Il est indispensable d'utiliser un navigateur internet récent pour les faire fonctionner. Les applications ont été testés sur Mozilla Firefox et Google Chrome.</p></div>
			</div>
			<div class="w3-container">
				<div class="w3-container w3-cell"><p><i class="fas fa-envelope fa-2x"></i></p></div>
				<div class="w3-container w3-cell"><p>pro.wal@protonmail.com</p></div>
			</div>
			<div class="w3-light-grey w3-section">
				<button onclick="accordion('licenceAccordion')" class="w3-button w3-block">
					<div class="w3-container w3-cell"><p><i class="fas fa-copyright fa-2x"></i></p></div>
					<div class="w3-container w3-cell"><p>MIT Licence</p></div>
				</button>
				<div id="licenceAccordion" class="w3-hide w3-container">
					<p><script src="lib/licence.js"></script></p>
				</div>
			</div>
    </div>
  </div>

<script>
const $ = document.querySelector.bind(document);

// Declare vars
const pointPerPeriod = 40;

// Canvas length
let totalTime = 5;

let periodPerFrame;
let blanckECGIntervalTime = 0.5;
let blanckECGInterval;

// ECG pattern
let rawECG = [];
let rawNoPECG = [];

// Full arythmic ECG array
let rawRandomECG = [];
// No P-Wave instruction dispatch array (bools)
let noPPeriods = [];

let noPFlag;

let chart;

// data1 = current frame array; data2 = past frame array
let data1 = [];
let data2 = [];

let startTime;
let time;

let paused = false;

// Used to seek in rawRandomECG faster
let indexCursor = 0;

let activeSportButtonID = 0;
let activeStateButtonID = 0;

// Get canvas context
const canvasCtx = $("canvas.canvas").getContext("2d");

// Set the periods
let period;
let periods = [];
periods[0] = [0.85,0.5,0.75]; // R = 70 120 80 Ir = 7
periods[1] = [0.8,0.5,0.7];
periods[2] = [1,0.54545,0.85]; // R = 60 110 70 Ir = 4
periods[3] = [0.8,0.5,0.7];
periods[4] = [0.66667,0.428571,0.6]; // R = 90 140 100 Ir = 13

// Get buttons contexts
let sportButtons = [];
sportButtons[0] = $("#sportButton1");
sportButtons[1] = $("#sportButton2");
sportButtons[2] = $("#sportButton3");
sportButtons[3] = $("#sportButton4");
sportButtons[4] = $("#sportButton5");

sportButtons[0].addEventListener("click", function(){onSportButtonClick(0)});
sportButtons[1].addEventListener("click", function(){onSportButtonClick(1)});
sportButtons[2].addEventListener("click", function(){onSportButtonClick(2)});
sportButtons[3].addEventListener("click", function(){onSportButtonClick(3)});
sportButtons[4].addEventListener("click", function(){onSportButtonClick(4)});

let stateButtons = [];
stateButtons[0] = $("#stateButton1");
stateButtons[1] = $("#stateButton2");
stateButtons[2] = $("#stateButton3");

stateButtons[0].addEventListener("click", function(){onStateButtonClick(0)});
stateButtons[1].addEventListener("click", function(){onStateButtonClick(1)});
stateButtons[2].addEventListener("click", function(){onStateButtonClick(2)});

const pauseButton = $("#pauseButton");
pauseButton.addEventListener("click", onPauseButtonClick);

const infoButton = $("#infoButton");
infoButton.addEventListener("click", onInfoButtonClick);

/*----------------------------------------------------------------------------------------------
-----------------------------------------GRAPH SETTINGS-----------------------------------------
----------------------------------------------------------------------------------------------*/
// Hack to hide ticks
let withTicks = {
	display: true,
	min: 0,
	max: totalTime,
	stepSize: 0.1
};

let noTicks = {
	display: false,
	autoSkip: false,
	min: 0,
	max: totalTime,
	stepSize: 0.08
};

let config = {
	type: "line",
	data: {
		datasets: [{
			label: "ECG",
			borderColor: phyColors.theme2,
			// Hides the points...
			radius: 0,
			fill: false
		},
		{
			label: "ECG2",
			borderColor: phyColors.theme2,
			radius: 0,
			fill: false
		}
		]
	},
	options: {
		lineTension: 0,
		responsive: true,
		animation: false,
		maintainAspectRatio: false,
		legend: {
				display: false
			},
		title: {
			display: false,
			fontSize : 20,
			fontColor: "#3f51b5",
			text: "Echelle horizontale : 1 graduation = 0,08 s"
		},
		scales: {
			xAxes: [{
				display: true,
				type: "linear",
				position: "bottom",
				scaleLabel: {
					display: true,
					labelString: "Temps (s)"
				},
				ticks: withTicks,
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					padding: 0,
					labelString: "Amplitude"
				},
				ticks: {
					suggestedMin: -2,
					suggestedMax: 6,
				}
			}]
		}
	}
};

/*----------------------------------------------------------------------------------------------
---------------------------------GENERATE RANDOM PERIODS ARRAY----------------------------------
----------------------------------------------------------------------------------------------*/
function generateRandomPeriods(){
	let timeCursor = 0;
	let randomPeriods = [];
	rawRandomECG[0] = {x: 0, y: 0};
	for(let i = 0; i < 1000; i++){
		randomPeriods[i] = period + 0.25 - Math.random() * 0.5;
		for(let j = 0; j < pointPerPeriod; j++){
			rawRandomECG[i * pointPerPeriod + j] = {
				x: timeCursor,
				y: rawECG[j].y
			};
			timeCursor += randomPeriods[i] / pointPerPeriod;
		};
	};
};

/*----------------------------------------------------------------------------------------------
-------------------------------GENERATE RANDOM NO P WAVE ARRAY----------------------------------
----------------------------------------------------------------------------------------------*/
function generateRandomNoP(){
	for(let i = 0; i < 5000; i++){
		if(Math.random() < 0.20){
			noPPeriods[i] = true;
		}
		else{
			noPPeriods[i] = false;
		}
	};
};

/*----------------------------------------------------------------------------------------------
-------------------------------------GENERATE ECG FUNCTIONS-------------------------------------
----------------------------------------------------------------------------------------------*/
function drawRegularECG(){
	// Generate the active frame data
	let frame = Math.floor(time / totalTime);
	let activeFramePeriodCount = frame * periodPerFrame;
	let activeFramePeriodCountInFrame = activeFramePeriodCount - Math.floor(activeFramePeriodCount);
	let activeFrameStartIndex = Math.floor(activeFramePeriodCountInFrame * pointPerPeriod);
	let activeFrameEndIndex = Math.floor((time - frame * totalTime) / period * pointPerPeriod);

	data1.length = 0;
	for(let i = 0; i < activeFrameEndIndex; i++){
		data1[i] = {
			x: i / pointPerPeriod * period,
			y:rawECG[(i + activeFrameStartIndex) % pointPerPeriod].y
		};
		// Check if P-Wave should be removed
		if(noPFlag == true && noPPeriods[Math.floor(activeFramePeriodCount) + Math.floor((i + activeFrameStartIndex) / pointPerPeriod)] == true){ // A fusionner avec draw ecg normal
			data1[i].y = rawNoPECG[(i + activeFrameStartIndex) % pointPerPeriod].y;
		};
	};

	// Generate the past frame data
	if(time > totalTime){
		let pastFramePeriodCount = (frame - 1) * periodPerFrame;
		let pastFramePeriodCountInFrame = pastFramePeriodCount - Math.floor(pastFramePeriodCount);
		let pastFrameStartIndex = Math.floor(pastFramePeriodCountInFrame * pointPerPeriod);
		let pastFrameEndIndex = periodPerFrame * pointPerPeriod;

		data2.length = 0;
		for(let i = activeFrameEndIndex + blanckECGInterval; i < pastFrameEndIndex; i++){
			data2[i - (activeFrameEndIndex + blanckECGInterval)] = {
				x: i / pointPerPeriod * period,
				y:rawECG[(i + pastFrameStartIndex) % pointPerPeriod].y
			};
			// Check if P-Wave should be removed
			if(noPFlag == true && noPPeriods[Math.floor(pastFramePeriodCount) + Math.floor((i + pastFrameStartIndex) / pointPerPeriod)] == true){
				data2[i - (activeFrameEndIndex + blanckECGInterval)].y = rawNoPECG[(i + pastFrameStartIndex) % pointPerPeriod].y;
			};
		};
	};

};

function drawArythmicECG(){
	// Reset when we reach "the end" of rawRandomECG
	if(time > 500){
		changePeriod();
	};
	// Find the usefull part of rawRandomECG
	let frame = Math.floor(time / totalTime);
	while(rawRandomECG[indexCursor].x < frame * totalTime){
		indexCursor++;
	};
	// Draw the active frame
	data1.length = 0;
	let ind = 0;
	while(rawRandomECG[ind + indexCursor].x < time){
		data1[ind] = {
			x: rawRandomECG[ind + indexCursor].x % totalTime,
			y: rawRandomECG[ind + indexCursor].y
		};
		ind++;
	};
	// Draw the past frame
	data2.length = 0;
	if(time > totalTime){
		let ind2 = 1;
		while(rawRandomECG[indexCursor - ind2].x > time - totalTime + blanckECGIntervalTime){
			data2[ind2] = {
				x: rawRandomECG[indexCursor - ind2].x % totalTime,
				y: rawRandomECG[indexCursor - ind2].y
			};
			ind2++;
		};
	};
};

/*----------------------------------------------------------------------------------------------
-------------------------------------CHANGE PERIOD FUNCTION-------------------------------------
----------------------------------------------------------------------------------------------*/
function changePeriod(){
	// Restart the time and set the period
	startTime = Date.now() / 1000;
	time = 0;
	period = periods[activeSportButtonID][activeStateButtonID];
	periodPerFrame = totalTime / period;
	blanckECGInterval = Math.trunc(pointPerPeriod / period * blanckECGIntervalTime); // 0.5s

	// randomECG and noP special inits
	indexCursor = 0;
	generateRandomPeriods();
	generateRandomNoP();

	// empty the datas
	data1.length = 0;
	data2.length = 0;
}

/*----------------------------------------------------------------------------------------------
---------------------------------------------EVENTS---------------------------------------------
----------------------------------------------------------------------------------------------*/
window.onload = function() {

	// Generate the raw ECG wave
	rawECG = ecg(pointPerPeriod, false);

	// Generate the raw ECG wave (without P wave)
	rawNoPECG = ecg(pointPerPeriod, true);

	// Create the graph and link the datas
	chart = new Chart(canvasCtx, config);
	chart.data.datasets[0].data = data1;
	chart.data.datasets[1].data = data2;

	// Set the default  settings
	onSportButtonClick(0);

	// Initial graph draw
	draw();
};

function onSportButtonClick(id){
	// Grey out all buttons
	for(let i = 0; i < 5; i++){
		sportButtons[i].classList.remove("w3-theme2");
		sportButtons[i].classList.add("w3-white");

	}

	// Highlight the active button
	sportButtons[id].classList.remove("w3-white");
	sportButtons[id].classList.add("w3-theme2");
	activeSportButtonID = id;

	if(id == 2 || id == 4){
		// Hack to hide the ticks
		chart.options.scales.xAxes[0].ticks = noTicks;
	}
	else{
		chart.options.scales.xAxes[0].ticks = withTicks;
	}

	// Display the scale as title
	if(id == 2){
		chart.options.title.display = true;
	}
	else{
		chart.options.title.display = false;
	}

	// Hide the vertical gridLines
	if(id == 4){
		chart.options.scales.xAxes[0].gridLines.display = false;
	}
	else{
		chart.options.scales.xAxes[0].gridLines.display = true;
	}

	onStateButtonClick(activeStateButtonID);
}

function onStateButtonClick(id){
	// Grey out all buttons
	for(let i = 0; i < 3; i++){
		stateButtons[i].classList.remove("w3-theme2");
		stateButtons[i].classList.add("w3-white");
	}

	// Highlight the active button
	stateButtons[id].classList.remove("w3-white");
	stateButtons[id].classList.add("w3-theme2");
	activeStateButtonID = id;

	changePeriod();
}

function onPauseButtonClick() {
	if(paused == true){
		paused = false;
		pauseButton.classList.remove("w3-red");
		pauseButton.classList.add("w3-white");
	}
	else{
		paused = true;
		pauseButton.classList.remove("w3-white");
		pauseButton.classList.add("w3-red");
	}
}

function onInfoButtonClick() {
	$("#modal").style.display="block";
}

/*----------------------------------------------------------------------------------------------
------------------------------------------DRAW FUNCTION-----------------------------------------
----------------------------------------------------------------------------------------------*/
function draw() {
	// Make sure we get called 60 times a second
	requestAnimationFrame(draw);

	// Get the time
	if(paused == true){
		startTime += Date.now() / 1000 - startTime - time;
	}
	time = Date.now() / 1000 - startTime;

	if(activeSportButtonID == 3){
		noPFlag = true;
	}
	else{
		noPFlag = false;
	}

	// Draw the ECG
	if(activeSportButtonID == 1){
		drawArythmicECG();
	}
	else{
		drawRegularECG();
	}
	var t0 = performance.now();
	chart.update();
	var t1 = performance.now();
	console.log("Call to doSomething took " + (t1 - t0) + " milliseconds.");
	
}
</script>
</body>
</html> 